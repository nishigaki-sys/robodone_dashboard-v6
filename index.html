<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ロボ団営業部ダッシュボード V5.0</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            blue: '#1E51A2',
                            orange: '#F3981E',
                            white: '#FFFFFF',
                            slate: '#F8FAFC'
                        }
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "recharts": "https://esm.sh/recharts@2.12.7?external=react,react-dom",
            "lucide-react": "https://esm.sh/lucide-react@0.395.0?external=react,react-dom",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js"
        }
    }
    </script>

    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #F8FAFC; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #1E51A2; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox 用 */
        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* 印刷用スタイル */
       @media print {
            body { 
                background-color: white; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
                margin: 0; 
                padding: 0;
                
                /* ▼▼▼ 追加: これで印刷時に自動的に83%縮小されます ▼▼▼ */
                zoom: 0.83; 
            }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .page-break { page-break-before: always; }
            @page { size: A4; margin: 5mm; } /* マージンは少し狭めに戻しておくと安全です */
            .report-container { width: 100%; max-width: 200mm; margin: 0 auto; }
        }
        
        /* 画面プレビューと印刷共通のテーブルスタイル */
        .print-only { display: none; } /* 通常時は非表示 */
        
        .report-preview-wrapper { 
            width: 210mm; 
            min-height: 297mm; 
            background: white; 
            margin: 0 auto; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            box-sizing: border-box; /* パディングを含める */
        }

        .report-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 10px; /* 9pxから10pxへサイズアップ */
            margin-bottom: 10px;
        }
        
        .report-table th, .report-table td { 
            border: 1px solid #444; /* 枠線を少し濃く */
            padding: 4px 2px; /* 上下左右のバランスを調整 */
            text-align: center; 
            vertical-align: middle;
            line-height: 1.3;
        }

        .report-table th { 
            background-color: #f3f4f6; 
            font-weight: 700; 
            white-space: nowrap; /* ヘッダーの文字崩れを防止 */
            color: #1f2937;
        }

        .report-section-title { 
            font-size: 12px; 
            font-weight: bold; 
            border-left: 5px solid #1E51A2; /* ブランドカラーを使用 */
            padding-left: 8px; 
            margin: 20px 0 8px 0; 
            color: #1f2937;
        }
        .print-only { display: none; }
        .report-preview-wrapper { width: 210mm; min-height: 297mm; background: white; margin: 0 auto; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect, useRef } from "react";
        import { createRoot } from "react-dom/client";
        import { BarChart, Bar, AreaChart, Area, LineChart, Line, ComposedChart, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceLine } from "recharts";
        import { 
            LayoutDashboard, Users, TrendingUp, Calendar, DollarSign, Activity, Loader2, 
            Settings, Plus, Trash2, School, FileText, Save, Sun, Cloud, CloudRain, Snowflake, Ban, PenTool, 
            ChevronRight, Upload, FileSpreadsheet, LogOut, ArrowRight, Megaphone, CheckCircle2, AlertCircle, X, ChevronDown, RefreshCw, Database, PieChart as PieIcon, Clock, Search, MapPin, Edit2, TrendingDown, Filter,
            ArrowUp, ArrowDown, Shield, Lock, LogIn, User, Printer, List
        } from "lucide-react";
        import { initializeApp } from "firebase/app";
        import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, updateDoc, getDocs, query, orderBy, where, serverTimestamp, writeBatch } from "firebase/firestore";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, updatePassword } from "firebase/auth";

        // ==========================================
        // 1. Firebase Config & Utilities
        // ==========================================
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCsgMN0SWCC1SvCDIakYBejTWlxwBmiwJk",
            authDomain: "robodone-dashboard.firebaseapp.com",
            projectId: "robodone-dashboard",
            storageBucket: "robodone-dashboard.firebasestorage.app",
            messagingSenderId: "457095919160",
            appId: "1:457095919160:web:1716af87290b63733598cd"
        };

        const CACHE_KEYS = {
            CAMPUSES: 'dash_campuses',
            ALL_DATA: 'dash_all_data',
            LAST_UPDATED: 'dash_last_updated'
        };

        let db = null;
        let auth = null;
        let isFirebaseInitialized = false;
        try {
            if (FIREBASE_CONFIG.apiKey) {
                const app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);
                isFirebaseInitialized = true;
            }
        } catch (e) { console.error("Firebase Init Error:", e); }

        const MONTHS_LIST = ['4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月'];
        const YEARS_LIST = [2022, 2023, 2024, 2025, 2026];
        
        const COLORS = {
            revenue: '#1E51A2', profit: '#10B981', profitOrd: '#059669', ad: '#F3981E', sales: '#F59E0B',
            labor: '#EF4444', facility: '#8B5CF6', admin: '#6366F1', hq: '#EC4899', other: '#94A3B8'
        };
        const PIE_COLORS = ['#1E51A2', '#F3981E', '#10B981', '#EF4444', '#8B5CF6', '#F59E0B', '#6366F1', '#EC4899', '#14B8A6', '#64748B'];
        const SUB_COLORS = ['#3B82F6', '#8B5CF6', '#EC4899', '#F43F5E', '#F97316', '#EAB308', '#10B981', '#14B8A6', '#06B6D4', '#6366F1'];

        const CATEGORY_MAP = {
            'revenue': { label: 'A51 売上', color: COLORS.revenue }, 'ad': { label: 'A61 広告宣伝費', color: COLORS.ad },
            'sales': { label: 'A62 販売費', color: COLORS.sales }, 'labor': { label: 'A63 人件費', color: COLORS.labor },
            'facility': { label: 'A64 設備費', color: COLORS.facility }, 'admin': { label: 'A65 一般管理費', color: COLORS.admin },
            'hq': { label: 'A69 本社費', color: COLORS.hq }, 'other': { label: 'その他費用', color: COLORS.other }
        };

        const formatYen = (val) => `¥${Number(val).toLocaleString()}`;
        
        const parseDate = (dateValue) => {
            if (!dateValue) return null;
            if (typeof dateValue.toDate === 'function') return dateValue.toDate();
            if (dateValue.seconds) return new Date(dateValue.seconds * 1000);
            if (typeof dateValue === 'string') {
                let cleanStr = dateValue.replace(/年|月/g, '/').replace(/日/g, ' ').replace(/\([^\)]+\)/g, '').trim();
                const d = new Date(cleanStr);
                if (!isNaN(d.getTime())) return d;
                return new Date(dateValue);
            }
            return new Date(dateValue);
        };

        const formatDateStr = (date) => {
            if (!date || isNaN(date.getTime())) return "";
            const y = date.getFullYear();
            const m = ('0' + (date.getMonth() + 1)).slice(-2);
            const d = ('0' + date.getDate()).slice(-2);
            return `${y}-${m}-${d}`;
        };
        const getFiscalYearFromStr = (dateStr) => {
            if (!dateStr) return -1;
            const [y, m] = dateStr.split('-').map(Number);
            if (!y || !m) return -1;
            return m < 4 ? y - 1 : y;
        };
        const getFiscalYear = (date) => (date.getMonth() < 3 ? date.getFullYear() - 1 : date.getFullYear());
        const normalizeString = (str) => (!str ? "" : str.replace(/[\s\u3000]/g, "").replace(/[Ａ-Ｚａ-ｚ０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)));

        const getWeeksStruct = (fiscalYear, monthIndex) => {
            let targetYear = fiscalYear;
            let jsMonth = monthIndex + 3; 
            if (jsMonth > 11) { jsMonth -= 12; targetYear += 1; }
            const daysInMonth = new Date(targetYear, jsMonth + 1, 0).getDate();
            const weeks = [];
            let startDay = 1;
            const firstDayObj = new Date(targetYear, jsMonth, 1);
            const isFirstDaySunday = firstDayObj.getDay() === 0;

            for (let day = 1; day <= daysInMonth; day++) {
                const dateObj = new Date(targetYear, jsMonth, day);
                const dayOfWeek = dateObj.getDay(); 
                let isWeekEnd = (dayOfWeek === 0) || (day === daysInMonth);
                if (isFirstDaySunday && day === 1 && daysInMonth > 1) { isWeekEnd = false; }
                if (isWeekEnd) {
                    weeks.push({ name: `第${weeks.length + 1}週`, startDay: startDay, endDay: day, label: `${startDay}日～${day}日` });
                    startDay = day + 1;
                }
            }
            return { weeks, daysInMonth, year: targetYear, month: jsMonth };
        };

       // ==========================================
        // 2. Data Processing Logic (修正完了版)
        // ==========================================
        const determineDetailedCategory = (code) => {
            if (!code) return 'other';
            const c = String(code);
            if (c.startsWith('51')) return 'revenue';
            if (c.startsWith('61')) return 'ad';
            if (c.startsWith('62')) return 'sales';
            if (c.startsWith('63')) return 'labor';
            if (c.startsWith('64')) return 'facility';
            if (c.startsWith('65')) return 'admin';
            if (c.startsWith('69')) return 'hq';
            if (c.startsWith('5')) return 'revenue'; 
            if (c.startsWith('6') || c.startsWith('7')) return 'other'; 
            return 'other';
        };

        const processDashboardData = (campuses, enrollments, statusChanges, transfers, dailyReports, financials, trialApps, targetYear) => {
            const sheetNameToIdMap = {};
            const targetCampusIds = new Set(campuses.map(c => c.id));
            
            // 校舎名マッピングの構築
            campuses.forEach(c => {
                // 1. 基本的な名称 (登録名・連携名)
                const validNames = [c.name, c.sheetName].filter(n => n);

                // 2. 指定ルールに基づくパターンの追加
                // ルール: 「ロボ団エディオン〇〇校」 or 「エディオン〇〇校」 (〇〇 = 校舎名)
                if (c.name) {
                    validNames.push(`ロボ団エディオン${c.name}校`);
                    validNames.push(`エディオン${c.name}校`);
                    // ※念のため "校" が抜けているケース("エディオン広島本店"など)も拾えるようにパターン追加
                    validNames.push(`ロボ団エディオン${c.name}`);
                    validNames.push(`エディオン${c.name}`);
                }

                // マップに登録 (そのままの文字列 と 正規化文字列の両方)
                validNames.forEach(n => {
                    sheetNameToIdMap[n] = c.id;
                    sheetNameToIdMap[normalizeString(n)] = c.id;
                });
            });

            // 集計対象判定ロジック (完全一致方式)
            const isTargetCampus = (item) => {
                // 1. IDがある場合はIDで判定 (最優先)
                if (item.campusId && targetCampusIds.has(item.campusId)) return true;

                // 2. IDがない場合は校舎名で判定
                const rawName = item.campus || item.school;
                if (!rawName) return false;

                // マップからIDを検索 (完全一致または正規化後の一致)
                const cId = sheetNameToIdMap[rawName] || sheetNameToIdMap[normalizeString(rawName)];
                
                // 対象のIDであればtrue
                return cId && targetCampusIds.has(cId);
            };

            let baseStudentCount = 0;
            const countBefore = (list, typeFilter = null) => {
                let count = 0;
                list.forEach(item => {
                    if (!isTargetCampus(item)) return;
                    let fy = -1;
                    if (typeof item.date === 'string' && item.date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                         fy = getFiscalYearFromStr(item.date);
                    } else { const d = parseDate(item.date); if (d) fy = getFiscalYear(d); }
                    if (fy === -1 || fy >= targetYear) return;
                    if (typeFilter && (!item.type || !item.type.includes(typeFilter))) return;
                    count++;
                });
                return count;
            };
            const prevEnroll = countBefore(enrollments);
            const prevTransferIn = countBefore(transfers); 
            const prevWithdraw = countBefore(statusChanges, "退会");
            const prevGrad = countBefore(statusChanges, "卒業");
            const prevTransferOut = countBefore(statusChanges, "転校");
            baseStudentCount = (prevEnroll + prevTransferIn) - (prevWithdraw + prevGrad + prevTransferOut);
            let currentStudents = baseStudentCount;

            return MONTHS_LIST.map((monthName, mIdx) => {
                const { weeks, daysInMonth, year: tYear, month: tMonth } = getWeeksStruct(targetYear, mIdx);
                const tYearPrev = tYear - 1;
                
                const mFinancials = financials.filter(fin => {
                    if (!isTargetCampus(fin)) return false;
                    const dateStr = typeof fin.date === 'string' ? fin.date : formatDateStr(parseDate(fin.date));
                    const [fY, fM] = dateStr.split('-').map(Number);
                    return fY === tYear && fM === (tMonth + 1);
                });
                const mFinancialsPrev = financials.filter(fin => {
                    if (!isTargetCampus(fin)) return false;
                    const dateStr = typeof fin.date === 'string' ? fin.date : formatDateStr(parseDate(fin.date));
                    const [fY, fM] = dateStr.split('-').map(Number);
                    return fY === tYearPrev && fM === (tMonth + 1);
                });

                const aggFinancials = (fins) => {
                    const agg = { revenue: 0, ad: 0, sales: 0, labor: 0, facility: 0, admin: 0, hq: 0, other: 0, expenseTotal: 0, partTime: 0 };
                    const details = {};
                    fins.forEach(f => {
                        const cat = determineDetailedCategory(f.accountCode);
                        if (cat === 'revenue') { agg.revenue += f.amount; } 
                        else { agg[cat] += f.amount; agg.expenseTotal += f.amount; }
                        if (String(f.accountCode).startsWith('6320')) { agg.partTime += f.amount; }
                        if (!details[cat]) details[cat] = [];
                        const existing = details[cat].find(i => i.name === f.subCategory);
                        if (existing) { existing.value += f.amount; } 
                        else { details[cat].push({ name: f.subCategory, value: f.amount, code: f.accountCode }); }
                    });
                    return { ...agg, details };
                };
                const currentFin = aggFinancials(mFinancials);
                const prevFin = aggFinancials(mFinancialsPrev);

                const filterPrevMonth = (list, typeFilter=null, dateKey='date') => list.filter(item => {
                    if (!isTargetCampus(item)) return false;
                    let d = parseDate(item[dateKey]);
                    if (!d) return false;
                    const iYear = d.getFullYear();
                    const iMonth = d.getMonth() + 1;
                    return iYear === tYearPrev && iMonth === (tMonth + 1) && (!typeFilter || item.type?.includes(typeFilter));
                }).length;
                const prevNewEnrollments = filterPrevMonth(enrollments);
                const prevWithdrawals = filterPrevMonth(statusChanges, "退会");

                const dailyData = Array.from({ length: daysInMonth }, (_, i) => {
                    const day = i + 1;
                    const dateStr = `${tYear}-${('0'+(tMonth+1)).slice(-2)}-${('0'+day).slice(-2)}`;
                    const dayOfWeek = new Date(tYear, tMonth, day).getDay();
                    const dayOfWeekStr = ['日', '月', '火', '水', '木', '金', '土'][dayOfWeek];
                    
                    const filterDay = (list, typeFilter=null, dateKey='date') => list.filter(item => {
                        if (!isTargetCampus(item)) return false; 
                        let itemDateStr = "";
                        const d = parseDate(item[dateKey]);
                        if (d) itemDateStr = formatDateStr(d);
                        return itemDateStr === dateStr && (!typeFilter || item.type?.includes(typeFilter));
                    }).length;

                    const dEnroll = filterDay(enrollments);
                    const dayReports = dailyReports.filter(r => r.date === dateStr && isTargetCampus(r));
                    const dFlyers = dayReports.reduce((sum, r) => sum + (Number(r.flyers) || 0), 0);
                    const dTouchTry = dayReports.reduce((sum, r) => sum + (Number(r.touchTry) || 0), 0);
                    const dTrialActual = dayReports.reduce((sum, r) => sum + (Number(r.trialLessons) || 0), 0);
                    const weather = dayReports.length > 0 ? dayReports[0].weather : '';
                    
                    const trialAppsOnly = trialApps.filter(a => a.type === '体験会');
                    const eventAppsOnly = trialApps.filter(a => a.type !== '体験会');
                    const dTrialApp = filterDay(trialAppsOnly, null, 'date');
                    const dEventApp = filterDay(eventAppsOnly, null, 'date');
                    const dTrialScheduled = filterDay(trialAppsOnly, null, 'trialDate'); 
                    const dEventScheduled = filterDay(eventAppsOnly, null, 'trialDate'); 
                    const dTransferIn = filterDay(transfers);
                    const dWithdraw = filterDay(statusChanges, "退会");
                    const dGrad = filterDay(statusChanges, "卒業");
                    const dTransferOut = filterDay(statusChanges, "転校");
                    const dRecess = filterDay(statusChanges, "休会");
                    
                    return {
                        name: `${day}日`, date: dateStr, dayOfWeek: dayOfWeekStr,
                        newEnrollments: dEnroll, flyers: dFlyers, touchTry: dTouchTry,
                        trialApp: dTrialApp, eventApp: dEventApp,
                        trialScheduled: dTrialScheduled, eventScheduled: dEventScheduled, 
                        trialActual: dTrialActual, weather: weather,
                        transferIns: dTransferIn, withdrawals: dWithdraw, 
                        graduates_neg: -dGrad, transfers_neg: -dTransferOut, withdrawals_neg: -dWithdraw, recesses_neg: -dRecess
                    };
                });

                const sumDaily = (key) => dailyData.reduce((acc, d) => acc + (d[key] || 0), 0);
               const weeklyData = weeks.map(week => {
                    const daysInWeek = dailyData.slice(week.startDay - 1, week.endDay);
                    const sum = (key) => daysInWeek.reduce((acc, d) => acc + (d[key] || 0), 0);
                    return {
                        name: week.name, label: week.label,
                        newEnrollments: sum('newEnrollments'), flyers: sum('flyers'), touchTry: sum('touchTry'),
                        trialApp: sum('trialApp'), eventApp: sum('eventApp'),
                        trialScheduled: sum('trialScheduled'), eventScheduled: sum('eventScheduled'), 
                        trialActual: sum('trialActual'),
                        // --- 以下を追加 ---
                        transferIns: sum('transferIns'),
                        withdrawals_neg: sum('withdrawals_neg'),
                        graduates_neg: sum('graduates_neg'),
                        transfers_neg: sum('transfers_neg')
                    };
                });

                const netChange = (sumDaily('newEnrollments') + sumDaily('transferIns')) - (sumDaily('withdrawals') + Math.abs(sumDaily('graduates_neg')) + Math.abs(sumDaily('transfers_neg')));
                currentStudents += netChange;

                return {
                    name: monthName, daily: dailyData, weekly: weeklyData,
                    newEnrollments: sumDaily('newEnrollments'), flyers: sumDaily('flyers'), touchTry: sumDaily('touchTry'),
                    trialApp: sumDaily('trialApp'), eventApp: sumDaily('eventApp'),
                    trialScheduled: sumDaily('trialScheduled'), eventScheduled: sumDaily('eventScheduled'),
                    trialActual: sumDaily('trialActual'), 
                    students: currentStudents,
                    ...currentFin, expense: currentFin.expenseTotal, profit: currentFin.revenue - currentFin.expenseTotal, detailItems: currentFin.details,
                    transferIns: sumDaily('transferIns'), withdrawals: sumDaily('withdrawals'),
                    withdrawals_neg: sumDaily('withdrawals_neg'), graduates_neg: sumDaily('graduates_neg'), transfers_neg: sumDaily('transfers_neg'), recesses_neg: sumDaily('recesses_neg'),
                    prevRevenue: prevFin.revenue, prevExpense: prevFin.expenseTotal, prevProfit: prevFin.revenue - prevFin.expenseTotal, 
                    prevNewEnrollments, prevWithdrawals
                };
            });
        };

        const aggregatePeriod = (monthlyData, periodType) => {
            if (periodType === 'annual') return monthlyData;
            let groups = [];
            if (periodType === 'half') { groups = [{ name: '上期', months: ['4月','5月','6月','7月','8月','9月'] }, { name: '下期', months: ['10月','11月','12月','1月','2月','3月'] }]; } 
            else if (periodType === 'quarter') { groups = [{ name: '第1四半期', months: ['4月','5月','6月'] }, { name: '第2四半期', months: ['7月','8月','9月'] }, { name: '第3四半期', months: ['10月','11月','12月'] }, { name: '第4四半期', months: ['1月','2月','3月'] }]; }

            return groups.map(g => {
                const targets = monthlyData.filter(d => g.months.includes(d.name));
                const agg = targets.reduce((acc, curr) => {
                    const keys = [
                        'revenue','expense','profit','ad','sales','labor','facility','admin','hq','other','partTime',
                        'newEnrollments','transferIns','returns','withdrawals','graduates_neg','transfers_neg','recesses_neg',
                        'flyers','touchTry','trialApp','eventApp','trialScheduled','eventScheduled','trialActual',
                        'withdrawals_neg', 'transfers_neg', 'graduates_neg', 'recesses_neg',
                        'prevRevenue', 'prevExpense', 'prevProfit', 'prevAd', 'prevSales', 'prevLabor', 'prevFacility', 'prevAdmin', 'prevHq', 'prevOther', 'prevNewEnrollments', 'prevWithdrawals'
                    ];
                    keys.forEach(k => { if (curr[k] !== undefined) acc[k] = (acc[k] || 0) + curr[k]; });
                    if (curr.detailItems) {
                        Object.keys(curr.detailItems).forEach(cat => {
                            if (!acc.detailItems[cat]) acc.detailItems[cat] = [];
                            curr.detailItems[cat].forEach(item => {
                                const existing = acc.detailItems[cat].find(i => i.name === item.name);
                                if (existing) existing.value += item.value; else acc.detailItems[cat].push({ ...item });
                            });
                        });
                    }
                    return acc;
                }, { name: g.name, detailItems: {} });
                
                if (targets.length > 0) { 
                    agg.students = targets[targets.length - 1].students; 
                }

                return agg;
            });
        };

        // ==========================================
        // 3. UI Components & Report Component
        // ==========================================
        const Notification = ({ msg, type, onClose }) => {
            if (!msg) return null;
            return (
                <div className={`fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg flex items-center gap-3 animate-in slide-in-from-top-5 ${type === 'error' ? 'bg-red-50 text-red-800 border border-red-200' : 'bg-emerald-50 text-emerald-800 border border-emerald-200'}`}>
                    {type === 'error' ? <AlertCircle className="w-5 h-5"/> : <CheckCircle2 className="w-5 h-5"/>}
                    <span className="text-sm font-medium">{msg}</span>
                    <button onClick={onClose}><X className="w-4 h-4 opacity-50 hover:opacity-100"/></button>
                </div>
            );
        };

        const StatCard = ({ title, value, subValue, iconUrl, colorClass, details, yoy }) => (
            <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-l-transparent hover:border-l-brand-orange transition-all duration-200 group h-full">
                <div className="flex flex-col items-start">
                    <div className="flex items-center gap-2 mb-1">
                        <p className="text-xs font-bold text-gray-400 uppercase tracking-wider">{title}</p>
                        {iconUrl && <img src={iconUrl} alt={title} className="w-5 h-5 object-contain" />}
                    </div>
                    <h3 className="text-2xl font-bold text-gray-800 group-hover:text-brand-blue transition-colors">{value}</h3>
                    {yoy && (
                        <div className="flex items-center mt-1 gap-1">
                             <span className="text-xs font-medium text-gray-400">前年比</span>
                             <span className={`text-sm font-bold ${Number(yoy) >= 100 ? 'text-emerald-500' : 'text-rose-500'}`}>{yoy}%</span>
                        </div>
                    )}
                </div>
                {subValue && <div className="mt-4 flex items-center text-sm"><span className="text-gray-400 font-medium">{subValue}</span></div>}
                {details && (
                    <div className="mt-4 pt-3 border-t border-slate-100 space-y-1">
                        {details.map((item, idx) => (
                            <div key={idx} className="flex justify-between text-xs text-slate-500">
                                <span>{item.label}</span><span className="font-medium text-slate-700">{item.value}</span>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );

        const DetailModal = ({ isOpen, onClose, data, title, color }) => {
            if (!isOpen || !data) return null;
            const chartData = data.filter(d => d.value > 0);
            const total = chartData.reduce((acc, curr) => acc + curr.value, 0);
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay backdrop-blur-sm transition-opacity" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] flex flex-col animate-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}>
                        <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl">
                            <div className="flex items-center gap-3">
                                <div className="p-2 rounded-lg bg-white shadow-sm" style={{color: color}}><Search className="w-5 h-5"/></div>
                                <div><h3 className="text-xl font-bold text-gray-800">{title} 詳細内訳</h3><p className="text-sm text-gray-500">合計: <span className="font-bold text-gray-700">{formatYen(total)}</span></p></div>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-gray-200 rounded-full transition-colors"><X className="w-5 h-5 text-gray-500"/></button>
                        </div>
                        <div className="p-6 overflow-y-auto flex-1">
                            <div className="flex flex-col md:flex-row gap-8">
                                <div className="w-full md:w-1/2 h-64">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie data={chartData} cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={2} dataKey="value">
                                                {chartData.map((entry, index) => <Cell key={`cell-${index}`} fill={PIE_COLORS[index % PIE_COLORS.length]} />)}
                                            </Pie>
                                            <Tooltip formatter={(value)=>formatYen(value)} />
                                        </PieChart>
                                    </ResponsiveContainer>
                                </div>
                                <div className="w-full md:w-1/2 space-y-3">
                                    {chartData.map((item, idx) => (
                                        <div key={idx} className="flex justify-between items-center p-3 rounded-lg border border-gray-100 hover:bg-gray-50 transition-colors">
                                            <div className="flex items-center gap-2">
                                                <div className="w-3 h-3 rounded-full" style={{backgroundColor: PIE_COLORS[idx % PIE_COLORS.length]}}></div>
                                                <div><div className="text-sm font-bold text-gray-700">{item.name}</div><div className="text-xs text-gray-400 font-mono">{item.code}</div></div>
                                            </div>
                                            <div className="text-right"><div className="text-sm font-bold text-gray-800">{formatYen(item.value)}</div><div className="text-xs text-gray-400">{((item.value/total)*100).toFixed(1)}%</div></div>
                                        </div>
                                    ))}
                                    {chartData.length === 0 && <div className="text-center text-gray-400 py-8">データがありません</div>}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CsvUploader = ({ onUpload, isUploading, targetYear, setTargetYear }) => {
            const fileInputRef = useRef(null);
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => parseCSV(event.target.result);
                reader.readAsText(file, 'Shift_JIS');
            };
            const parseCSV = (text) => {
                const lines = text.split(/\r\n|\n/);
                const data = [];
                let headerIdx = -1;
                for(let i=0; i<lines.length; i++) {
                    if (lines[i].includes('勘定コード') || lines[i].includes('科目') || lines[i].includes('４月')) { headerIdx = i; break; }
                }
                if (headerIdx === -1) { alert("フォーマット認識エラー"); return; }
                const headers = lines[headerIdx].split(',').map(h => h.trim());
                const monthMap = {}; 
                headers.forEach((h, idx) => { const mMatch = h.match(/([０-９0-9]+)月/); if (mMatch) monthMap[h] = idx; });
                for (let i = headerIdx + 1; i < lines.length; i++) {
                    const line = lines[i].trim(); if (!line) continue;
                    const cols = line.split(',');
                    const codeCol = cols[0] ? cols[0].trim() : '';
                    if (!/^\d/.test(codeCol)) continue;
                    const parts = codeCol.split(/\s+/);
                    const code = parts[0];
                    const name = parts.length > 1 ? parts.slice(1).join(' ') : '不明';
                    let category = 'other';
                    let signMultiplier = 1;
                    if (code.startsWith('5')) { category = 'revenue'; signMultiplier = -1; } 
                    else if (code.startsWith('6') || code.startsWith('7')) { category = 'expense'; signMultiplier = 1; } 
                    else { continue; }
                    Object.entries(monthMap).forEach(([monthLabel, colIdx]) => {
                        const rawVal = cols[colIdx];
                        if (rawVal) {
                            const val = Number(rawVal);
                            if (!isNaN(val) && val !== 0) {
                                const monthNum = parseInt(monthLabel.replace('月','').replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)));
                                data.push({ month: monthNum, category, subCategory: name, amount: val * signMultiplier, accountCode: code });
                            }
                        }
                    });
                }
                onUpload(data);
                if (fileInputRef.current) fileInputRef.current.value = "";
            };
            return (
                <div className="space-y-4">
                    <div className="flex items-center justify-between bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <label className="text-sm font-bold text-gray-700">取り込み対象年度:</label>
                        <select value={targetYear} onChange={(e) => setTargetYear(Number(e.target.value))} className="bg-white border border-gray-300 rounded px-3 py-1.5 text-sm font-bold text-gray-700 outline-none focus:ring-2 focus:ring-brand-blue">
                            {YEARS_LIST.map(y => <option key={y} value={y}>{y}年度</option>)}
                        </select>
                    </div>
                    <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:bg-gray-50 transition-colors cursor-pointer group" onClick={() => fileInputRef.current?.click()}>
                        <input type="file" accept=".csv" ref={fileInputRef} className="hidden" onChange={handleFileChange} />
                        <div className="w-16 h-16 bg-blue-50 text-brand-blue rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                            {isUploading ? <Loader2 className="w-8 h-8 animate-spin" /> : <Upload className="w-8 h-8" />}
                        </div>
                        <h3 className="text-lg font-bold text-gray-700 mb-1">収支CSVファイルをアップロード</h3>
                    </div>
                </div>
            );
        };
        
        // --- 帳票出力コンポーネント (予実対比・KPIカード) ---
        const ReportView = ({ year, month, campus, dailyData, weeklyData, planData, summaryData }) => {
            const weatherMap = { sunny: '晴', cloudy: '曇', rainy: '雨', snowy: '雪', closed: '-' };
            const weeklyPlans = planData[month]?.weeks || [];
            const getDiff = (plan, actual) => (actual || 0) - (plan || 0);

            // 計画データ取得
            const monthlyPlan = planData[month] || {};
            // 実績データ取得
            const actualEnrollments = summaryData.newEnrollments;
            const actualWithdrawals = summaryData.withdrawals;
            const actualStudents = summaryData.students;

            let plannedStudents = Number(monthlyPlan.students) || 0; 

            // KPIカード用データ
            const kpiData = [
                { label: "在籍生徒数", value: `${actualStudents}名`, plan: `${plannedStudents}名`, diff: actualStudents - plannedStudents },
                { label: "入会数", value: `${actualEnrollments}名`, plan: `${monthlyPlan.enrollments || 0}名`, diff: actualEnrollments - (monthlyPlan.enrollments || 0) },
                { label: "退会数", value: `${actualWithdrawals}名`, plan: `${monthlyPlan.withdrawals || 0}名`, diff: actualWithdrawals - (monthlyPlan.withdrawals || 0) },
            ];

            return (
                <div className="report-preview-wrapper p-10 relative print:p-0 print:w-full print:shadow-none" style={{ fontFamily: '"Noto Sans JP", sans-serif', color: '#111' }}>
                    <div className="flex justify-between items-end mb-8 border-b-2 border-gray-800 pb-3">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-900">ロボ団教室実績管理表 {year}年{month}</h1>
                            <div className="text-sm mt-1 font-medium text-gray-700">校舎名: {campus.name} (ID: {campus.id})</div>
                        </div>
                        <div className="text-xs text-right text-gray-500">
                            <div>作成日: {new Date().toLocaleDateString()}</div>
                        </div>
                    </div>

                    {/* KPIカードセクション */}
                    <div className="grid grid-cols-3 gap-4 mb-8">
                        {kpiData.map((kpi, i) => (
                            <div key={i} className="border border-gray-300 p-3 rounded bg-white shadow-sm flex flex-col items-center">
                                <div className="text-xs font-bold text-gray-500 mb-1">{kpi.label}</div>
                                <div className="text-2xl font-bold mb-1 text-gray-800">{kpi.value}</div>
                                <div className="text-xs flex gap-3 text-gray-600 font-medium">
                                    <span>計画: {kpi.plan}</span>
                                    <span className={typeof kpi.diff === 'number' && kpi.diff < 0 ? 'text-red-600' : 'text-blue-600'}>
                                        差異: {typeof kpi.diff === 'number' && kpi.diff > 0 ? '+' : ''}{kpi.diff}
                                    </span>
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="space-y-6">
                        {/* 1. 日別実績 */}
                        <div>
                            <div className="report-section-title">1. 日別実績</div>
                            <table className="report-table">
                                <thead>
                                    <tr>
                                        {/* 幅指定を削除し、自動調整させる */}
                                        <th>日付</th><th>曜</th><th>天候</th>
                                        <th>門配</th><th>T&T</th>
                                        <th className="bg-blue-50">体験申込</th>
                                        <th className="bg-yellow-50">参加予定</th>
                                        <th className="bg-orange-50">参加実績</th>
                                        <th className="bg-green-50">入会数</th>
                                        <th style={{width: '20%'}}>備考</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {dailyData.map((day, idx) => (
                                        <tr key={idx}>
                                            <td>{day.name.replace('日','')}</td>
                                            <td className={day.dayOfWeek==='土'?'text-blue-600 font-bold':day.dayOfWeek==='日'?'text-red-600 font-bold':''}>{day.dayOfWeek}</td>
                                            <td>{weatherMap[day.weather] || day.weather || '-'}</td>
                                            <td>{day.flyers || ''}</td><td>{day.touchTry || ''}</td>
                                            <td className="bg-blue-50">{day.trialApp || ''}</td><td className="bg-yellow-50">{day.trialScheduled || ''}</td><td className="bg-orange-50">{day.trialActual || ''}</td><td className="bg-green-50">{day.newEnrollments || ''}</td>
                                            <td className="text-left px-2 text-[9px]">{/* 備考があればここへ */}</td>
                                        </tr>
                                    ))}
                                    <tr className="font-bold bg-gray-100">
                                        <td colSpan="3">月度合計</td>
                                        <td>{dailyData.reduce((s,d)=>s+(d.flyers||0),0)}</td>
                                        <td>{dailyData.reduce((s,d)=>s+(d.touchTry||0),0)}</td>
                                        <td className="bg-blue-50">{dailyData.reduce((s,d)=>s+(d.trialApp||0),0)}</td>
                                        <td className="bg-yellow-50">{dailyData.reduce((s,d)=>s+(d.trialScheduled||0),0)}</td>
                                        <td className="bg-orange-50">{dailyData.reduce((s,d)=>s+(d.trialActual||0),0)}</td>
                                        <td className="bg-green-50">{dailyData.reduce((s,d)=>s+(d.newEnrollments||0),0)}</td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        {/* 2. 集客活動 & 3. 体験・入会 (左右配置) */}
                        <div className="grid grid-cols-2 gap-8 items-start">
                            {/* 左側：集客活動 */}
                            <div>
                                <div className="report-section-title">2. 集客活動 (週次)</div>
                                <table className="report-table">
                                    <thead>
                                        <tr><th rowSpan="2">期間</th><th colSpan="3">T&T</th><th colSpan="3">門配</th></tr>
                                        <tr className="bg-gray-50"><th>計画</th><th>実績</th><th>差異</th><th>計画</th><th>実績</th><th>差異</th></tr>
                                    </thead>
                                    <tbody>
                                        {weeklyData.map((w, i) => {
                                            const plan = weeklyPlans[i] || {};
                                            return (
                                                <tr key={i}>
                                                    <td className="text-xs">{w.label}</td>
                                                    <td>{plan.touchTry || 0}</td><td>{w.touchTry}</td><td className={getDiff(plan.touchTry, w.touchTry)<0 ? 'text-red-600 font-bold':''}>{getDiff(plan.touchTry, w.touchTry)}</td>
                                                    <td>{plan.flyers || 0}</td><td>{w.flyers}</td><td className={getDiff(plan.flyers, w.flyers)<0 ? 'text-red-600 font-bold':''}>{getDiff(plan.flyers, w.flyers)}</td>
                                                </tr>
                                            );
                                        })}
                                        <tr className="font-bold bg-gray-100">
                                            <td>月度計</td>
                                            <td>{weeklyPlans.reduce((s,p)=>s+(p.touchTry||0),0)}</td><td>{weeklyData.reduce((s,w)=>s+w.touchTry,0)}</td><td>{weeklyData.reduce((s,w)=>s+w.touchTry,0) - weeklyPlans.reduce((s,p)=>s+(p.touchTry||0),0)}</td>
                                            <td>{weeklyPlans.reduce((s,p)=>s+(p.flyers||0),0)}</td><td>{weeklyData.reduce((s,w)=>s+w.flyers,0)}</td><td>{weeklyData.reduce((s,w)=>s+w.flyers,0) - weeklyPlans.reduce((s,p)=>s+(p.flyers||0),0)}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            {/* 右側：体験・入会 */}
                            <div>
                                <div className="report-section-title">3. 体験・入会 (週次)</div>
                                <table className="report-table">
                                    <thead>
                                        <tr><th rowSpan="2">期間</th><th colSpan="3">体験申込</th><th colSpan="3">体験参加</th><th colSpan="3">入会</th></tr>
                                        <tr className="bg-gray-50"><th>計画</th><th>実績</th><th>差異</th><th>計画</th><th>実績</th><th>差異</th><th>計画</th><th>実績</th><th>差異</th></tr>
                                    </thead>
                                    <tbody>
                                        {weeklyData.map((w, i) => {
                                            const plan = weeklyPlans[i] || {};
                                            return (
                                                <tr key={i}>
                                                    <td className="text-xs">{w.label}</td>
                                                    <td>{plan.trialApp || 0}</td><td>{w.trialApp}</td><td className={getDiff(plan.trialApp, w.trialApp)<0 ? 'text-red-600 font-bold':''}>{getDiff(plan.trialApp, w.trialApp)}</td>
                                                    <td>{plan.trialParticipation || 0}</td><td>{w.trialActual}</td><td className={getDiff(plan.trialParticipation, w.trialActual)<0 ? 'text-red-600 font-bold':''}>{getDiff(plan.trialParticipation, w.trialActual)}</td>
                                                    <td>{plan.enrollments || 0}</td><td>{w.newEnrollments}</td><td className={getDiff(plan.enrollments, w.newEnrollments)<0 ? 'text-red-600 font-bold':''}>{getDiff(plan.enrollments, w.newEnrollments)}</td>
                                                </tr>
                                            );
                                        })}
                                        <tr className="font-bold bg-gray-100">
                                            <td>月度計</td>
                                            <td>{weeklyPlans.reduce((s,p)=>s+(p.trialApp||0),0)}</td><td>{weeklyData.reduce((s,w)=>s+w.trialApp,0)}</td><td>{weeklyData.reduce((s,w)=>s+w.trialApp,0) - weeklyPlans.reduce((s,p)=>s+(p.trialApp||0),0)}</td>
                                            <td>{weeklyPlans.reduce((s,p)=>s+(p.trialParticipation||0),0)}</td><td>{weeklyData.reduce((s,w)=>s+w.trialActual,0)}</td><td>{weeklyData.reduce((s,w)=>s+w.trialActual,0) - weeklyPlans.reduce((s,p)=>s+(p.trialParticipation||0),0)}</td>
                                            <td>{weeklyPlans.reduce((s,p)=>s+(p.enrollments||0),0)}</td><td>{weeklyData.reduce((s,w)=>s+w.newEnrollments,0)}</td><td>{weeklyData.reduce((s,w)=>s+w.newEnrollments,0) - weeklyPlans.reduce((s,p)=>s+(p.enrollments||0),0)}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // --- 年間予算計画表コンポーネント ---
        const AnnualReportView = ({ year, campus, planData }) => {
            const months = ['4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月'];
            
            // 集計ロジック
            const getValues = (key) => months.map(m => Number(planData[m]?.[key] || 0));
            const sum = (arr) => arr.reduce((a, b) => a + b, 0);
            const avg = (arr) => arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;

            // データ取得
            const students = getValues('students');
            const withdrawals = getValues('withdrawals');
            const touchTry = getValues('touchTry');
            const flyers = getValues('flyers');
            const trials = getValues('trials'); // 年間計画入力では'trials'を使用
            const enrollments = getValues('enrollments');
            
            const revenue = getValues('revenue');
            const entranceFee = getValues('entranceFee');
            const otherSales = getValues('otherSales');
            const adCost = getValues('adCost');
            const salesCost = getValues('salesCost');
            const laborCost = getValues('laborCost');
            const facilityCost = getValues('facilityCost');
            const adminCost = getValues('adminCost');

            // 期間別集計ヘルパー
            const calcPeriod = (values, type = 'sum') => {
                const first = values.slice(0, 6);
                const second = values.slice(6, 12);
                const all = values;
                
                if (type === 'avg') {
                    return { first: avg(first), second: avg(second), annual: avg(all) };
                }
                return { first: sum(first), second: sum(second), annual: sum(all) };
            };

            // 各項目の集計
            const agg = {
                students: calcPeriod(students, 'avg'),
                withdrawals: calcPeriod(withdrawals),
                touchTry: calcPeriod(touchTry),
                flyers: calcPeriod(flyers),
                trials: calcPeriod(trials),
                enrollments: calcPeriod(enrollments),
                
                revenue: calcPeriod(revenue),
                entranceFee: calcPeriod(entranceFee),
                otherSales: calcPeriod(otherSales),
                adCost: calcPeriod(adCost),
                salesCost: calcPeriod(salesCost),
                laborCost: calcPeriod(laborCost),
                facilityCost: calcPeriod(facilityCost),
                adminCost: calcPeriod(adminCost),
            };

            // 利益計算 (各月)
            const profits = months.map((_, i) => {
                const totalRev = revenue[i] + entranceFee[i] + otherSales[i];
                const totalExp = adCost[i] + salesCost[i] + laborCost[i] + facilityCost[i] + adminCost[i];
                return totalRev - totalExp;
            });
            const aggProfit = calcPeriod(profits);

            // 入会率計算
            const calcRate = (enroll, trial) => trial > 0 ? ((enroll / trial) * 100).toFixed(1) + '%' : '0.0%';

            // セル描画ヘルパー
            const RenderRow = ({ label, values, periodData, type = 'sum', isRate = false, trialValues = null }) => (
                <tr>
                    <td className="bg-gray-50 font-bold text-left px-2">{label}</td>
                    {values.map((v, i) => (
                        <td key={i} className="text-right px-1">
                            {isRate ? calcRate(v, trialValues[i]) : v.toLocaleString()}
                        </td>
                    ))}
                    <td className="bg-blue-50 text-right px-1 font-medium">
                        {isRate ? calcRate(periodData.first, agg.trials.first) : (type === 'avg' ? periodData.first.toFixed(1) : periodData.first.toLocaleString())}
                    </td>
                    <td className="bg-blue-50 text-right px-1 font-medium">
                        {isRate ? calcRate(periodData.second, agg.trials.second) : (type === 'avg' ? periodData.second.toFixed(1) : periodData.second.toLocaleString())}
                    </td>
                    <td className="bg-yellow-50 text-right px-1 font-bold">
                        {isRate ? calcRate(periodData.annual, agg.trials.annual) : (type === 'avg' ? periodData.annual.toFixed(1) : periodData.annual.toLocaleString())}
                    </td>
                </tr>
            );

            return (
                <div className="report-preview-wrapper p-10 relative print:p-0 print:w-full print:shadow-none" style={{ fontFamily: '"Noto Sans JP", sans-serif', color: '#111' }}>
                    <div className="flex justify-between items-end mb-6 border-b-2 border-gray-800 pb-3">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-900">年間予算計画表 {year}年度</h1>
                            <div className="text-sm mt-1 font-medium text-gray-700">教室名: {campus.name}</div>
                        </div>
                        <div className="text-xs text-right text-gray-500">
                            <div>作成日: {new Date().toLocaleDateString()}</div>
                        </div>
                    </div>

                    {/* KPI Section */}
                    <div className="mb-8">
                        <div className="report-section-title">▼KPI</div>
                        <table className="report-table">
                            <thead>
                                <tr>
                                    <th className="w-24">項目</th>
                                    {months.map(m => <th key={m}>{m}</th>)}
                                    <th className="bg-blue-100">上期</th>
                                    <th className="bg-blue-100">下期</th>
                                    <th className="bg-yellow-100">年度</th>
                                </tr>
                            </thead>
                            <tbody>
                                <RenderRow label="生徒数(期末)" values={students} periodData={agg.students} type="avg" />
                                <RenderRow label="退会数" values={withdrawals} periodData={agg.withdrawals} />
                                <RenderRow label="T&T" values={touchTry} periodData={agg.touchTry} />
                                <RenderRow label="門前配布" values={flyers} periodData={agg.flyers} />
                                <RenderRow label="体験会人数" values={trials} periodData={agg.trials} />
                                <RenderRow label="入会数" values={enrollments} periodData={agg.enrollments} />
                                <RenderRow label="入会率" values={enrollments} periodData={agg.enrollments} isRate={true} trialValues={trials} />
                            </tbody>
                        </table>
                    </div>

                    {/* PL Section */}
                    <div>
                        <div className="report-section-title">▼PL (単位:円)</div>
                        <table className="report-table">
                            <thead>
                                <tr>
                                    <th className="w-24">項目</th>
                                    {months.map(m => <th key={m}>{m}</th>)}
                                    <th className="bg-blue-100">上期</th>
                                    <th className="bg-blue-100">下期</th>
                                    <th className="bg-yellow-100">年度</th>
                                </tr>
                            </thead>
                            <tbody>
                                <RenderRow label="(+)売上(月謝)" values={revenue} periodData={agg.revenue} />
                                <RenderRow label="(+)入会金" values={entranceFee} periodData={agg.entranceFee} />
                                <RenderRow label="(+)その他" values={otherSales} periodData={agg.otherSales} />
                                <tr className="bg-gray-100"><td colSpan={16} className="h-1"></td></tr>
                                <RenderRow label="(-)広告宣伝費" values={adCost} periodData={agg.adCost} />
                                <RenderRow label="(-)販売費" values={salesCost} periodData={agg.salesCost} />
                                <RenderRow label="(-)人件費" values={laborCost} periodData={agg.laborCost} />
                                <RenderRow label="(-)設備費" values={facilityCost} periodData={agg.facilityCost} />
                                <RenderRow label="(-)一般管理費" values={adminCost} periodData={agg.adminCost} />
                                <tr className="border-t-2 border-gray-400">
                                    <td className="bg-gray-100 font-bold px-2">営業利益</td>
                                    {profits.map((v, i) => (
                                        <td key={i} className={`text-right px-1 font-bold ${v < 0 ? 'text-red-600' : ''}`}>{v.toLocaleString()}</td>
                                    ))}
                                    <td className={`bg-blue-50 text-right px-1 font-bold ${aggProfit.first < 0 ? 'text-red-600' : ''}`}>{aggProfit.first.toLocaleString()}</td>
                                    <td className={`bg-blue-50 text-right px-1 font-bold ${aggProfit.second < 0 ? 'text-red-600' : ''}`}>{aggProfit.second.toLocaleString()}</td>
                                    <td className={`bg-yellow-50 text-right px-1 font-bold ${aggProfit.annual < 0 ? 'text-red-600' : ''}`}>{aggProfit.annual.toLocaleString()}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };
        
        // ==========================================
        // ログインコンポーネント
        // ==========================================
        const Login = () => {
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError("");
                try {
                    const auth = getAuth();
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setError("ログインに失敗しました。メールアドレスとパスワードを確認してください。");
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
                    <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-brand-blue rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-brand-blue/20">
                                <LayoutDashboard className="w-8 h-8 text-white" />
                            </div>
                            <h2 className="text-2xl font-bold text-gray-800">ロボ団営業部ダッシュボード</h2>
                            <p className="text-gray-500 mt-2">ログインしてダッシュボードにアクセス</p>
                        </div>
                        {error && (
                            <div className="mb-4 p-3 bg-red-50 text-red-700 text-sm rounded-lg flex items-start">
                                <AlertCircle className="w-5 h-5 mr-2 flex-shrink-0" />
                                <span>{error}</span>
                            </div>
                        )}
                        <form onSubmit={handleLogin} className="space-y-6">
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">メールアドレス</label>
                                <input 
                                    type="email" 
                                    required 
                                    className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-blue focus:border-transparent outline-none transition-all"
                                    placeholder="your@email.com"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">パスワード</label>
                                <input 
                                    type="password" 
                                    required 
                                    className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-blue focus:border-transparent outline-none transition-all"
                                    placeholder="••••••••"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                />
                            </div>
                            <button 
                                type="submit" 
                                disabled={loading}
                                className="w-full bg-brand-blue text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center"
                            >
                                {loading ? <Loader2 className="w-5 h-5 animate-spin" /> : <><LogIn className="w-5 h-5 mr-2" /> ログイン</>}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // ==========================================
        // マイページコンポーネント
        // ==========================================
        const MyPage = ({ user, onBack, showNotify }) => {
            const [newPass, setNewPass] = useState("");
            const [confPass, setConfPass] = useState("");
            const [isUpdating, setIsUpdating] = useState(false);

            const handleUpdate = async (e) => {
                e.preventDefault();
                if (newPass !== confPass) {
                    showNotify("パスワードが一致しません", "error");
                    return;
                }
                if (newPass.length < 6) {
                    showNotify("パスワードは6文字以上で設定してください", "error");
                    return;
                }
                
                setIsUpdating(true);
                try {
                    await updatePassword(user, newPass);
                    showNotify("パスワードを更新しました");
                    setNewPass("");
                    setConfPass("");
                } catch (error) {
                    console.error(error);
                    if (error.code === 'auth/requires-recent-login') {
                        showNotify("セキュリティのため、再ログイン後に再度お試しください", "error");
                    } else {
                        showNotify("更新に失敗しました: " + error.message, "error");
                    }
                } finally {
                    setIsUpdating(false);
                }
            };

            return (
                <div className="min-h-screen bg-brand-slate p-6 fade-in">
                    <div className="max-w-2xl mx-auto">
                        <button onClick={onBack} className="flex items-center text-gray-500 hover:text-gray-700 mb-6 font-bold">
                            <ArrowUp className="w-4 h-4 mr-1 -rotate-90" /> 戻る
                        </button>
                        
                        <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                            <div className="p-6 border-b border-gray-100 bg-gray-50">
                                <div className="flex items-center gap-4">
                                    <div className="w-12 h-12 bg-white rounded-full flex items-center justify-center border border-gray-200 text-brand-blue">
                                        <User className="w-6 h-6" />
                                    </div>
                                    <div>
                                        <h2 className="text-xl font-bold text-gray-800">マイページ</h2>
                                        <p className="text-sm text-gray-500">{user.email}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="p-8">
                                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <Lock className="w-5 h-5 mr-2 text-brand-blue"/>
                                    パスワード変更
                                </h3>
                                <form onSubmit={handleUpdate} className="space-y-4 max-w-md">
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">新しいパスワード</label>
                                        <input 
                                            type="password" 
                                            className="w-full border border-gray-300 rounded px-3 py-2 outline-none focus:ring-2 focus:ring-brand-blue"
                                            placeholder="6文字以上"
                                            value={newPass}
                                            onChange={(e) => setNewPass(e.target.value)}
                                            minLength={6}
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">新しいパスワード（確認）</label>
                                        <input 
                                            type="password" 
                                            className="w-full border border-gray-300 rounded px-3 py-2 outline-none focus:ring-2 focus:ring-brand-blue"
                                            placeholder="もう一度入力"
                                            value={confPass}
                                            onChange={(e) => setConfPass(e.target.value)}
                                            minLength={6}
                                            required
                                        />
                                    </div>
                                    <div className="pt-2">
                                        <button 
                                            type="submit" 
                                            disabled={isUpdating}
                                            className="bg-brand-blue text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors flex items-center disabled:opacity-50"
                                        >
                                            {isUpdating ? <Loader2 className="w-4 h-4 animate-spin mr-2"/> : <Save className="w-4 h-4 mr-2"/>}
                                            パスワードを更新する
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

       // ==========================================
        // 4. School Console Component (完全版: CSV一括取込機能 & 日付補正対応)
        // ==========================================
        function SchoolConsole({ onBack, campus, allData, selectedYear, setSelectedYear, refreshData, showNotify, isAdmin }) {
            const [activeTab, setActiveTab] = useState('daily');
            const [planMode, setPlanMode] = useState('annual'); // 'annual' | 'monthly'
            const [reportMode, setReportMode] = useState('monthly'); // 'monthly' | 'annual'
            const [selectedMonth, setSelectedMonth] = useState(() => { const d = new Date(); return (d.getMonth() + 1) + '月'; });
            const [reportDate, setReportDate] = useState(formatDateStr(new Date()));
            const [inputData, setInputData] = useState({ weather: 'sunny', flyers: 0, touch: 0, trial: 0, comment: '' });
            const [uploading, setUploading] = useState(false);
            const [planData, setPlanData] = useState({ initialStudents: 0 }); 
            const [isSavingPlan, setIsSavingPlan] = useState(false);
            const [uploadTargetYear, setUploadTargetYear] = useState(selectedYear);
            const [isInputModalOpen, setIsInputModalOpen] = useState(false);

            // --- 追加: CSVインポート用コンポーネント ---
            const CSVImportPanel = () => {
                const dailyFileRef = useRef(null);
                const planFileRef = useRef(null);
                const [importType, setImportType] = useState('daily'); // 'daily' or 'plan'
                const [isProcessing, setIsProcessing] = useState(false);

                // CSVパース共通処理
                const parseCSV = (file, callback) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const text = e.target.result;
                        // 改行コードで分割し、空行を除去
                        const lines = text.split(/\r\n|\n/).filter(line => line.trim() !== '');
                        if (lines.length < 2) {
                            showNotify("データが含まれていないか、ヘッダーのみのようです", "error");
                            return;
                        }
                        callback(lines);
                    };
                    // 日本語(Shift_JIS)で読み込み
                    reader.readAsText(file, 'Shift_JIS');
                };

                // 日報インポート処理 (日付処理強化版)
                const handleDailyImport = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    setIsProcessing(true);

                    parseCSV(file, async (lines) => {
                        try {
                            const batchLimit = 450;
                            let batch = writeBatch(db);
                            let count = 0;
                            let totalCount = 0;

                            for (let i = 1; i < lines.length; i++) {
                                // カンマで分割し、前後の空白とダブルクォートを除去
                                const cols = lines[i].split(',').map(c => c.trim().replace(/^"|"$/g, ''));
                                
                                // 日付がない行はスキップ
                                if (!cols[0]) continue;
                                
                                // --- 【修正】日付文字列を直接解析して YYYY-MM-DD を作る ---
                                // "2025/11/1" や "2025-11-01" を想定
                                const dateParts = cols[0].split(/[\/\-]/); // スラッシュかハイフンで分割
                                if (dateParts.length !== 3) {
                                    console.warn(`日付形式エラー行: ${i+1} [${cols[0]}]`);
                                    continue;
                                }

                                const y = dateParts[0];
                                const m = ('0' + dateParts[1]).slice(-2); // ゼロ埋め
                                const d = ('0' + dateParts[2]).slice(-2); // ゼロ埋め
                                const dateStr = `${y}-${m}-${d}`;
                                // -------------------------------------------------------

                                const weatherMap = { '晴': 'sunny', '曇': 'cloudy', '雨': 'rainy', '雪': 'snowy', '休': 'closed' };
                                const weather = weatherMap[cols[1]] || 'sunny';
                                
                                const flyers = cols[2] === '' ? 0 : Number(cols[2]);
                                const touchTry = cols[3] === '' ? 0 : Number(cols[3]);
                                const trialLessons = cols[4] === '' ? 0 : Number(cols[4]);
                                const comment = cols[5] || '';

                                const docRef = doc(db, "daily_reports", `${campus.id}_${dateStr}`);
                                batch.set(docRef, {
                                    campusId: campus.id,
                                    date: dateStr,
                                    weather,
                                    flyers: isNaN(flyers) ? 0 : flyers,
                                    touchTry: isNaN(touchTry) ? 0 : touchTry,
                                    trialLessons: isNaN(trialLessons) ? 0 : trialLessons,
                                    comment,
                                    updatedAt: serverTimestamp()
                                });

                                count++;
                                totalCount++;

                                if (count >= batchLimit) {
                                    await batch.commit();
                                    batch = writeBatch(db);
                                    count = 0;
                                }
                            }
                            if (count > 0) await batch.commit();
                            
                            showNotify(`${totalCount}件の日報データを取り込みました`);
                            refreshData();
                        } catch (err) {
                            console.error("Import Error Details:", err);
                            showNotify("取込エラー: " + err.message, "error");
                        } finally {
                            setIsProcessing(false);
                            if (dailyFileRef.current) dailyFileRef.current.value = "";
                        }
                    });
                };

                // 計画インポート処理
                const handlePlanImport = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    setIsProcessing(true);

                    parseCSV(file, async (lines) => {
                        try {
                            const updates = {}; 

                            for (let i = 1; i < lines.length; i++) {
                                const cols = lines[i].split(',').map(c => c.trim());
                                if (!cols[0] || !cols[1] || !cols[2]) continue;

                                const year = Number(cols[0]);
                                const month = cols[1]; 
                                const weekStr = cols[2]; 
                                const weekIndex = parseInt(weekStr.replace(/[^0-9]/g, '')) - 1;

                                if (isNaN(weekIndex) || weekIndex < 0) continue;

                                if (!updates[year]) updates[year] = {};
                                if (!updates[year][month]) updates[year][month] = {};

                                updates[year][month][weekIndex] = {
                                    touchTry: Number(cols[3]) || 0,
                                    flyers: Number(cols[4]) || 0,
                                    trialApp: Number(cols[5]) || 0,
                                    trialParticipation: Number(cols[6]) || 0,
                                    enrollments: Number(cols[7]) || 0
                                };
                            }

                            for (const year of Object.keys(updates)) {
                                const docRef = doc(db, "campus_plans", `${campus.id}_${year}`);
                                const snap = await getDoc(docRef);
                                let plans = snap.exists() ? snap.data().plans : {};

                                Object.keys(updates[year]).forEach(month => {
                                    if (!plans[month]) plans[month] = { weeks: [] };
                                    if (!plans[month].weeks) plans[month].weeks = [];

                                    Object.keys(updates[year][month]).forEach(wIdx => {
                                        while (plans[month].weeks.length <= wIdx) {
                                            plans[month].weeks.push({});
                                        }
                                        plans[month].weeks[wIdx] = {
                                            ...plans[month].weeks[wIdx],
                                            ...updates[year][month][wIdx]
                                        };
                                    });
                                });

                                await setDoc(docRef, {
                                    campusId: campus.id,
                                    year: Number(year),
                                    plans: plans,
                                    updatedAt: serverTimestamp()
                                });
                            }

                            showNotify("週次計画データを取り込みました");
                            refreshData();
                        } catch (err) {
                            console.error(err);
                            showNotify("取込エラー: " + err.message, "error");
                        } finally {
                            setIsProcessing(false);
                            if (planFileRef.current) planFileRef.current.value = "";
                        }
                    });
                };

                return (
                    <div className="space-y-8 animate-in fade-in">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h3 className="font-bold text-gray-800 mb-6 flex items-center">
                                <Upload className="w-5 h-5 mr-2 text-brand-blue"/> データ一括取込
                            </h3>

                            <div className="flex gap-4 mb-6">
                                <button onClick={()=>setImportType('daily')} className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${importType==='daily' ? 'bg-brand-blue text-white shadow' : 'bg-gray-100 text-gray-500'}`}>日報データ</button>
                                <button onClick={()=>setImportType('plan')} className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${importType==='plan' ? 'bg-brand-blue text-white shadow' : 'bg-gray-100 text-gray-500'}`}>週次計画データ</button>
                            </div>

                            {importType === 'daily' && (
                                <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center bg-gray-50 hover:bg-blue-50 transition-colors">
                                    <h4 className="font-bold text-gray-700 mb-2">日報CSVのアップロード</h4>
                                    <p className="text-xs text-gray-500 mb-6">形式: 日付(yyyy/mm/dd), 天気, 門配数, T&T数, 体験実施数, コメント</p>
                                    
                                    <input type="file" ref={dailyFileRef} accept=".csv" onChange={handleDailyImport} className="hidden" />
                                    <button 
                                        onClick={() => dailyFileRef.current?.click()} 
                                        disabled={isProcessing}
                                        className="bg-white border border-gray-300 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-white hover:border-brand-blue hover:text-brand-blue shadow-sm flex items-center justify-center mx-auto transition-all"
                                    >
                                        {isProcessing ? <Loader2 className="w-5 h-5 animate-spin mr-2"/> : <FileText className="w-5 h-5 mr-2 text-brand-orange"/>}
                                        CSVファイルを選択
                                    </button>
                                    <p className="mt-2 text-[10px] text-gray-400">※日付は「2025/1/1」形式でも自動補正して取り込みます</p>
                                </div>
                            )}

                            {importType === 'plan' && (
                                <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center bg-gray-50 hover:bg-blue-50 transition-colors">
                                    <h4 className="font-bold text-gray-700 mb-2">週次計画CSVのアップロード</h4>
                                    <p className="text-xs text-gray-500 mb-6">形式: 年度, 月(例:4月), 週(例:第1週), T&T, 門配, 体験申込, 体験実施, 入会</p>
                                    
                                    <input type="file" ref={planFileRef} accept=".csv" onChange={handlePlanImport} className="hidden" />
                                    <button 
                                        onClick={() => planFileRef.current?.click()} 
                                        disabled={isProcessing}
                                        className="bg-white border border-gray-300 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-white hover:border-brand-blue hover:text-brand-blue shadow-sm flex items-center justify-center mx-auto transition-all"
                                    >
                                        {isProcessing ? <Loader2 className="w-5 h-5 animate-spin mr-2"/> : <TrendingUp className="w-5 h-5 mr-2 text-brand-orange"/>}
                                        CSVファイルを選択
                                    </button>
                                </div>
                            )}

                            <div className="mt-6 p-4 bg-blue-50 rounded-lg text-xs text-blue-800 border border-blue-100">
                                <p className="font-bold mb-1 flex items-center"><AlertCircle className="w-3 h-3 mr-1"/>注意点:</p>
                                <ul className="list-disc list-inside space-y-1 opacity-80">
                                    <li>文字コードは <strong>Shift_JIS</strong> で保存されたCSVを使用してください。</li>
                                    <li>1行目はヘッダーとしてスキップされます。</li>
                                    <li>既存のデータがある日付や週は、CSVの内容で<strong>上書き</strong>されます。</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                );
            };

            // 印刷用スタイル（モードに応じて用紙サイズと向きを切り替え）
            const reportStyle = `
                @media print {
                    @page { 
                        size: A4 ${reportMode === 'annual' ? 'landscape' : 'portrait'}; 
                        margin: 5mm; 
                    }
                    body {
                        zoom: ${reportMode === 'annual' ? '0.9' : '0.83'}; /* 横向き時は少し縮小率を緩和 */
                    }
                }
                /* プレビュー画面の用紙サイズ調整 */
                .report-preview-wrapper {
                    width: ${reportMode === 'annual' ? '297mm' : '210mm'} !important;
                    min-height: ${reportMode === 'annual' ? '210mm' : '297mm'} !important;
                }
            `;

            // ダッシュボードデータの計算 (レポート用)
            const dashboardData = useMemo(() => {
                if (!campus) return [];
                return processDashboardData([campus], allData.enrollments, allData.statusChanges, allData.transfers, allData.dailyReports, allData.financials, allData.trialApps, Number(selectedYear));
            }, [campus, allData, selectedYear]);

            const currentMonthData = useMemo(() => {
                return dashboardData.find(d => d.name === selectedMonth) || { daily: [], weekly: [], students: 0, newEnrollments: 0, withdrawals: 0 };
            }, [dashboardData, selectedMonth]);

            const lastUploadInfo = useMemo(() => {
                if (!campus || !allData.financialUpdates) return null;
                const update = allData.financialUpdates.find(u => u.campusId === campus.id && u.fiscalYear === uploadTargetYear);
                return update ? parseDate(update.updatedAt) : null;
            }, [campus, allData.financialUpdates, uploadTargetYear]);

            const currentWeeksStruct = useMemo(() => {
                const mIdx = MONTHS_LIST.indexOf(selectedMonth);
                return getWeeksStruct(Number(selectedYear), mIdx);
            }, [selectedYear, selectedMonth]);

            useEffect(() => {
                if (activeTab === 'plan' || activeTab === 'report') {
                    const fetchPlan = async () => {
                        try {
                            const docRef = doc(db, "campus_plans", `${campus.id}_${selectedYear}`);
                            const docSnap = await getDoc(docRef);
                            setPlanData(docSnap.exists() ? { initialStudents: 0, ...docSnap.data().plans } : { initialStudents: 0 });
                        } catch (e) { console.error(e); }
                    };
                    fetchPlan();
                }
            }, [activeTab, campus, selectedYear]);

            // 生徒数推移を含めた計画データの計算
            const calculatedPlanData = useMemo(() => {
                const newData = { ...planData };
                let currentStudentCount = Number(newData.initialStudents) || 0;
                
                MONTHS_LIST.forEach(m => {
                    if (!newData[m]) newData[m] = {};
                    const enroll = Number(newData[m].enrollments || 0);
                    const withdraw = Number(newData[m].withdrawals || 0);
                    const monthEndStudents = currentStudentCount + enroll - withdraw;
                    newData[m].students = monthEndStudents;
                    currentStudentCount = monthEndStudents;
                });
                return newData;
            }, [planData]);

            useEffect(() => {
                if (!campus) return;
                const existing = allData.dailyReports.find(r => r.campusId === campus.id && r.date === reportDate);
                if (existing) {
                    setInputData({
                        weather: existing.weather || 'sunny', 
                        flyers: existing.flyers || 0, 
                        touch: existing.touchTry || 0, 
                        trial: existing.trialLessons || 0,
                        comment: existing.comment || ''
                    });
                } else { 
                    setInputData({ weather: 'sunny', flyers: 0, touch: 0, trial: 0, comment: '' }); 
                }
            }, [reportDate, allData.dailyReports, campus]);

            const handleDateClick = (dateStr) => { setReportDate(dateStr); setIsInputModalOpen(true); };
            
            const handleSaveReport = async () => {
                if (!campus) return;
                try {
                    await setDoc(doc(db, "daily_reports", `${campus.id}_${reportDate}`), {
                        campusId: campus.id, 
                        date: reportDate, 
                        weather: inputData.weather,
                        flyers: Number(inputData.flyers), 
                        touchTry: Number(inputData.touch), 
                        trialLessons: Number(inputData.trial),
                        comment: inputData.comment,
                        updatedAt: serverTimestamp()
                    });
                    refreshData(); showNotify("日報を保存しました"); setIsInputModalOpen(false);
                } catch(e) { showNotify("エラー: " + e.message, 'error'); }
            };

            const handleDeleteReport = async () => {
                if (!campus) return;
                if (!confirm("この日の日報データを完全に削除（リセット）しますか？")) return;
                try {
                    await deleteDoc(doc(db, "daily_reports", `${campus.id}_${reportDate}`));
                    setInputData({ weather: 'sunny', flyers: 0, touch: 0, trial: 0, comment: '' });
                    refreshData(); 
                    showNotify("日報データを削除しました"); 
                    setIsInputModalOpen(false);
                } catch(e) { showNotify("削除エラー: " + e.message, 'error'); }
            };

            const updatePlanData = (month, key, value, weekIndex = null) => {
                let normalizedValue = value;
                if (typeof value === 'string') {
                    normalizedValue = value.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
                }
                const newValue = normalizedValue === '' ? '' : Number(normalizedValue);

                setPlanData(prev => {
                    const newData = { ...prev };
                    if (month === 'initial' && key === 'students') {
                        newData.initialStudents = newValue;
                        return newData;
                    }
                    if (!newData[month]) newData[month] = {};
                    if (weekIndex !== null) {
                        if (!newData[month].weeks) newData[month].weeks = [];
                        const weeks = [...newData[month].weeks];
                        if (!weeks[weekIndex]) weeks[weekIndex] = {};
                        weeks[weekIndex] = { ...weeks[weekIndex], [key]: newValue };
                        newData[month].weeks = weeks;
                    } else {
                        newData[month] = { ...newData[month], [key]: newValue };
                    }
                    return newData;
                });
            };

            const handleSavePlan = async () => {
                if (!campus) return;
                setIsSavingPlan(true);
                try {
                    await setDoc(doc(db, "campus_plans", `${campus.id}_${selectedYear}`), { campusId: campus.id, year: selectedYear, plans: planData, updatedAt: serverTimestamp() });
                    showNotify("計画を保存しました");
                } catch (e) { showNotify("保存失敗: " + e.message, 'error'); } finally { setIsSavingPlan(false); }
            };
            
            let currentStudentCount = Number(planData.initialStudents) || 0;

            const weeklyTotals = useMemo(() => {
                if (!planData[selectedMonth]?.weeks) return { touchTry:0, flyers:0, trialApp:0, trialParticipation:0, enrollments:0 };
                return planData[selectedMonth].weeks.reduce((acc, curr) => ({
                    touchTry: acc.touchTry + (curr?.touchTry || 0),
                    flyers: acc.flyers + (curr?.flyers || 0),
                    trialApp: acc.trialApp + (curr?.trialApp || 0),
                    trialParticipation: acc.trialParticipation + (curr?.trialParticipation || 0),
                    enrollments: acc.enrollments + (curr?.enrollments || 0),
                }), { touchTry:0, flyers:0, trialApp:0, trialParticipation:0, enrollments:0 });
            }, [planData, selectedMonth]);
            
            // 既存の収支取込機能
            const handleCsvUpload = async (parsedData) => {
                if (!campus) return;
                setUploading(true);
                try {
                    const batchSize = 450; 
                    const q = query(collection(db, "financials"), where("campusId", "==", campus.id), where("fiscalYear", "==", uploadTargetYear));
                    const snapshot = await getDocs(q);
                    const chunks = [];
                    for (let i = 0; i < snapshot.docs.length; i += batchSize) chunks.push(snapshot.docs.slice(i, i + batchSize));
                    for (const chunk of chunks) { const deleteBatch = writeBatch(db); chunk.forEach(doc => deleteBatch.delete(doc.ref)); await deleteBatch.commit(); }
                    const insertChunks = [];
                    for (let i = 0; i < parsedData.length; i += batchSize) insertChunks.push(parsedData.slice(i, i + batchSize));
                    for (const chunk of insertChunks) {
                        const insertBatch = writeBatch(db);
                        chunk.forEach(item => {
                            let tYear = Number(uploadTargetYear); if (item.month <= 3) tYear += 1;
                            const dateStr = `${tYear}-${('0'+item.month).slice(-2)}-01`;
                            const ref = doc(collection(db, "financials"));
                            insertBatch.set(ref, { 
                                date: dateStr, fiscalYear: uploadTargetYear, amount: item.amount, 
                                category: item.category, subCategory: item.subCategory, accountCode: item.accountCode,
                                campusId: campus.id, createdAt: serverTimestamp() 
                            });
                        });
                        await insertBatch.commit();
                    }
                    await setDoc(doc(db, "financial_updates", `${campus.id}_${uploadTargetYear}`), { campusId: campus.id, fiscalYear: uploadTargetYear, updatedAt: serverTimestamp() });
                    refreshData(); showNotify(`${parsedData.length}件のデータを取り込みました (重複削除済み)`);
                } catch (e) { showNotify("エラー: " + e.message, 'error'); } finally { setUploading(false); }
            };

            if (!campus) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-brand-blue"/></div>;
            const weatherMap = { sunny: {i:Sun,l:'晴',c:'text-orange-500'}, cloudy: {i:Cloud,l:'曇',c:'text-gray-500'}, rainy: {i:CloudRain,l:'雨',c:'text-blue-500'}, snowy: {i:Snowflake,l:'雪',c:'text-cyan-500'}, closed: {i:Ban,l:'休',c:'text-red-500'} };
            
            const isJanFebMar = ['1月', '2月', '3月'].includes(selectedMonth);
            const displayCalendarYear = isJanFebMar ? Number(selectedYear) + 1 : Number(selectedYear);

            return (
                <div className="flex h-screen bg-brand-slate overflow-hidden fade-in print:block print:h-auto print:overflow-visible print:bg-white">
                    {/* 動的スタイル（印刷設定の制御） */}
                    <style>{reportStyle}</style>

                    {/* レポート印刷用ビュー */}
                    <div className="print-only">
                         {reportMode === 'monthly' ? (
                            <ReportView 
                                year={displayCalendarYear} 
                                month={selectedMonth} 
                                campus={campus} 
                                dailyData={currentMonthData.daily} 
                                weeklyData={currentMonthData.weekly} 
                                planData={calculatedPlanData} 
                                summaryData={{
                                    students: currentMonthData.students,
                                    newEnrollments: currentMonthData.newEnrollments,
                                    withdrawals: currentMonthData.withdrawals
                                }}
                             />
                         ) : (
                            <AnnualReportView 
                                year={selectedYear}
                                campus={campus}
                                planData={calculatedPlanData}
                            />
                         )}
                    </div>

                    {isInputModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay backdrop-blur-sm transition-opacity no-print" onClick={() => setIsInputModalOpen(false)}>
                            <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full animate-in zoom-in-95 duration-200 p-6" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-lg font-bold text-gray-800 flex items-center"><PenTool className="w-5 h-5 mr-2 text-brand-blue"/> 日報入力</h3>
                                    <div className="text-sm font-bold text-gray-500">{reportDate}</div>
                                </div>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-gray-400 block mb-2">天気</label>
                                        <div className="flex gap-2 justify-between">
                                            {Object.entries(weatherMap).map(([k,v])=><button key={k} onClick={()=>setInputData({...inputData,weather:k})} className={`flex-1 py-2 rounded-lg border flex flex-col items-center justify-center transition-colors ${inputData.weather===k?'bg-blue-50 border-brand-blue':'border-gray-100 hover:bg-gray-50'}`}><v.i className={`w-4 h-4 mb-1 ${v.c}`}/><span className="text-[10px] font-bold text-gray-500">{v.l}</span></button>)}
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-gray-400 block mb-1">門配数</label>
                                            <input type="number" value={inputData.flyers} onChange={e => { const val = e.target.value.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)); setInputData({...inputData, flyers: val}); }} className="w-full border rounded p-2 text-right font-bold text-gray-700"/>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-400 block mb-1">T&T数</label>
                                            <input type="number" value={inputData.touch} onChange={e => { const val = e.target.value.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)); setInputData({...inputData, touch: val}); }} className="w-full border rounded p-2 text-right font-bold text-gray-700"/>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-400 block mb-1">体験会実施数</label>
                                        <input type="number" value={inputData.trial} onChange={e => { const val = e.target.value.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)); setInputData({...inputData, trial: val}); }} className="w-full border rounded p-2 text-right font-bold text-gray-700"/>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-400 block mb-1">コメント (100文字以内)</label>
                                        <textarea value={inputData.comment} onChange={e=>setInputData({...inputData,comment:e.target.value})} maxLength={100} className="w-full border rounded p-2 text-sm text-gray-700 h-20 resize-none focus:ring-2 focus:ring-brand-orange outline-none" placeholder="特記事項があれば入力..."/>
                                        <div className="text-right text-[10px] text-gray-400">{inputData.comment.length}/100</div>
                                    </div>
                                    <div className="flex gap-2 mt-6 pt-4 border-t border-gray-100">
                                        <button onClick={handleDeleteReport} className="p-3 text-red-500 hover:bg-red-50 rounded-lg" title="データを削除"><Trash2 className="w-5 h-5"/></button>
                                        <button onClick={() => setIsInputModalOpen(false)} className="flex-1 py-3 text-gray-500 hover:bg-gray-100 rounded-lg font-bold text-sm">キャンセル</button>
                                        <button onClick={handleSaveReport} className="flex-1 bg-brand-orange text-white font-bold py-3 rounded-lg hover:bg-orange-600 shadow-sm flex items-center justify-center text-sm"><Save className="w-4 h-4 mr-2"/>保存</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    <aside className="w-64 bg-white border-r border-gray-200 flex flex-col z-10 no-print">
                        <div className="p-6 border-b border-gray-100">
                            <div className="flex items-center space-x-2 mb-1"><School className="w-5 h-5 text-brand-orange" /><span className="font-bold text-sm text-brand-orange">校舎</span></div>
                            <h2 className="text-xl font-bold text-gray-800 truncate">{campus.name}</h2>
                        </div>
                        <nav className="flex-1 p-4 space-y-1">
                            {[{id:'daily',l:'日報入力',i:Calendar}, {id:'plan',l:'計画策定',i:FileText}, {id:'import',l:'データ取込',i:Upload}, {id:'report',l:'帳票出力',i:Printer}, {id:'finance',l:'収支取込',i:FileSpreadsheet}].map(t => {
                                if (t.id === 'finance' && !isAdmin) return (
                                    <button key={t.id} onClick={() => setActiveTab(t.id)} className="w-full flex items-center px-4 py-3 rounded-lg text-gray-400 hover:bg-gray-50 transition-colors">
                                        <div className="relative"><t.i className="w-5 h-5 mr-3" /><Lock className="w-3 h-3 absolute -top-1 -right-1 text-gray-400" /></div>{t.l}
                                    </button>
                                );
                                return (
                                    <button key={t.id} onClick={() => setActiveTab(t.id)} className={`w-full flex items-center px-4 py-3 rounded-lg transition-colors ${activeTab === t.id ? 'bg-brand-orange text-white shadow-md shadow-brand-orange/30' : 'text-gray-500 hover:bg-gray-50'}`}>
                                        <t.i className="w-5 h-5 mr-3" />{t.l}
                                    </button>
                                )
                            })}
                        </nav>
                        <div className="p-4 border-t border-gray-100"><button onClick={onBack} className="flex items-center text-gray-400 hover:text-gray-600 text-sm w-full px-4 py-2"><LogOut className="w-4 h-4 mr-2" /> 戻る</button></div>
                    </aside>
                    <main className="flex-1 overflow-y-auto no-print">
                        <header className="bg-white h-16 border-b border-gray-200 flex items-center justify-between px-8 sticky top-0 z-20">
                            <h2 className="text-xl font-bold text-gray-800">{{daily:'日報管理', plan:'計画策定', import:'データ一括取込', report:'帳票出力', finance:'収支管理'}[activeTab]}</h2>
                            <div className="flex items-center space-x-4">
                                <select value={selectedYear} onChange={(e)=>setSelectedYear(e.target.value)} className="bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5 text-sm font-bold text-gray-600 focus:ring-2 focus:ring-brand-orange outline-none">
                                    {YEARS_LIST.map(y => <option key={y} value={y}>{y}年度</option>)}
                                </select>
                                <div className="w-8 h-8 rounded-full bg-brand-blue flex items-center justify-center text-white font-bold text-xs">SC</div>
                            </div>
                        </header>
                        <div className="p-8 w-full mx-auto">
                           {/* 日報入力タブ */}
                            {activeTab === 'daily' && (
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-in fade-in">
                                    <div className="lg:col-span-3 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                                        <div className="flex justify-between mb-4">
                                            <h3 className="font-bold text-gray-700 flex items-center"><Calendar className="w-4 h-4 mr-2"/> {displayCalendarYear}年 {selectedMonth}</h3>
                                            <div className="flex gap-1">{MONTHS_LIST.map(m=><button key={m} onClick={()=>setSelectedMonth(m)} className={`text-xs px-2 py-1 rounded ${selectedMonth===m?'bg-brand-orange text-white':'text-gray-400 hover:bg-gray-100'}`}>{m}</button>)}</div>
                                        </div>
                                        <div className="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200 rounded-lg overflow-hidden">
                                            {['日','月','火','水','木','金','土'].map((d,i)=><div key={i} className="bg-gray-50 text-center py-2 text-xs font-bold text-gray-500">{d}</div>)}
                                            
                                            {/* カレンダー生成ロジック */}
                                            {(() => {
                                                const targetMonthIdx = MONTHS_LIST.indexOf(selectedMonth);
                                                let tYear = Number(selectedYear);
                                                let tMonth = targetMonthIdx + 3; 
                                                if (tMonth > 11) { tMonth -= 12; tYear++; }

                                                const firstDayOfWeek = new Date(tYear, tMonth, 1).getDay();
                                                const daysInMonth = new Date(tYear, tMonth + 1, 0).getDate();

                                                const emptyCells = Array.from({ length: firstDayOfWeek }).map((_, i) => (
                                                    <div key={`empty-${i}`} className="bg-gray-50/50 min-h-[96px]" />
                                                ));

                                                const dayCells = Array.from({ length: daysInMonth }, (_, i) => i + 1).map(d => {
                                                    const dateStr = `${tYear}-${('0'+(tMonth+1)).slice(-2)}-${('0'+d).slice(-2)}`; 
                                                    const report = allData.dailyReports.find(r => r.campusId === campus.id && r.date === dateStr);
                                                    const WeatherIcon = report && weatherMap[report.weather] ? weatherMap[report.weather].i : null;
                                                    const isToday = dateStr === formatDateStr(new Date());
                                                    
                                                    return (
                                                        <div key={d} onClick={()=>handleDateClick(dateStr)} className={`bg-white h-24 p-1 cursor-pointer hover:bg-blue-50 relative flex flex-col justify-between border border-transparent hover:border-blue-200 ${isToday?'bg-blue-50/60':''}`}>
                                                            <div className="flex justify-between items-start">
                                                                <span className={`text-xs font-bold ${isToday?'text-brand-blue':'text-gray-700'}`}>{d}</span>
                                                                {WeatherIcon && <WeatherIcon className={`w-3 h-3 ${weatherMap[report.weather].c}`}/>}
                                                            </div>
                                                            {report && (
                                                                <div className="text-[9px] text-gray-500 space-y-0.5">
                                                                    <div className="flex justify-between"><span>門配</span><span className="font-bold">{report.flyers}</span></div>
                                                                    <div className="flex justify-between"><span>T&T</span><span className="font-bold">{report.touchTry}</span></div>
                                                                    <div className="flex justify-between"><span>体験</span><span className="font-bold">{report.trialLessons}</span></div>
                                                                    {report.comment && <div className="absolute bottom-1 right-1 w-1.5 h-1.5 bg-brand-orange rounded-full"></div>}
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                });

                                                return [...emptyCells, ...dayCells];
                                            })()}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* 計画策定タブ */}
                            {activeTab === 'plan' && (
                                <div className="space-y-6 animate-in fade-in">
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                                        <div className="flex justify-between items-center mb-6">
                                            <div className="flex items-center gap-4">
                                                <h3 className="font-bold text-gray-800 flex items-center"><TrendingUp className="w-5 h-5 mr-2 text-brand-orange"/> {selectedYear}年度 計画策定</h3>
                                                <div className="flex bg-gray-100 p-1 rounded-lg">
                                                    <button onClick={() => setPlanMode('annual')} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${planMode==='annual' ? 'bg-white text-brand-orange shadow-sm' : 'text-gray-500'}`}>年間計画</button>
                                                    <button onClick={() => setPlanMode('monthly')} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${planMode==='monthly' ? 'bg-white text-brand-orange shadow-sm' : 'text-gray-500'}`}>月度計画 (週次)</button>
                                                </div>
                                            </div>
                                            <button onClick={handleSavePlan} disabled={isSavingPlan} className="bg-brand-blue text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-blue-700 flex items-center">{isSavingPlan ? <Loader2 className="animate-spin w-4 h-4 mr-2"/> : <Save className="w-4 h-4 mr-2"/>} 保存する</button>
                                        </div>

                                        {/* 年間計画モード */}
                                        {planMode === 'annual' && (
                                            <div className="overflow-x-auto w-full">
                                                <div className="mb-8 w-full">
                                                    <h4 className="font-bold text-gray-700 mb-2 border-l-4 border-brand-orange pl-2">1. 生徒・マーケティング計画</h4>
                                                    <div className="flex items-center mb-4 bg-orange-50 p-3 rounded-lg border border-orange-100">
                                                        <label className="text-sm font-bold text-gray-600 mr-2">期首生徒数:</label>
                                                        <input 
                                                            type="number" 
                                                            value={planData.initialStudents ?? ''} 
                                                            onChange={(e)=>updatePlanData('initial', 'students', e.target.value)} 
                                                            onFocus={(e) => e.target.select()}
                                                            className="bg-white border border-gray-300 rounded px-2 py-1 text-right w-24 font-bold text-brand-orange"
                                                        />
                                                        <span className="text-xs text-gray-500 ml-2">※ここに入力した人数から、各月の入会・退会計画を加減して生徒数が自動計算されます。</span>
                                                    </div>
                                                    <table className="w-full text-xs text-left border-collapse">
                                                        <thead className="bg-gray-50 text-gray-500 font-medium border-b border-gray-200">
                                                            <tr>
                                                                <th className="px-2 py-2 whitespace-nowrap">月度</th>
                                                                <th className="px-2 py-2 whitespace-nowrap bg-gray-50">生徒数</th>
                                                                <th className="px-1 py-2 text-center whitespace-nowrap">退会数</th>
                                                                <th className="px-1 py-2 text-center whitespace-nowrap">T&T数</th>
                                                                <th className="px-1 py-2 text-center whitespace-nowrap">門配数</th>
                                                                <th className="px-1 py-2 text-center whitespace-nowrap">体験数</th>
                                                                <th className="px-1 py-2 text-center whitespace-nowrap">入会数</th>
                                                                <th className="px-2 py-2 whitespace-nowrap bg-gray-50">入会率</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y divide-gray-100">
                                                            {MONTHS_LIST.map((m) => {
                                                                const d = planData[m] || {};
                                                                const rate = d.trials > 0 ? ((d.enrollments / d.trials) * 100).toFixed(1) : 0;
                                                                const enroll = Number(d.enrollments || 0);
                                                                const withdraw = Number(d.withdrawals || 0);
                                                                const monthEndStudents = currentStudentCount + enroll - withdraw;
                                                                currentStudentCount = monthEndStudents; 

                                                                return (
                                                                    <tr key={m} className="hover:bg-gray-50">
                                                                        <td className="px-2 py-2 font-bold text-gray-700">{m}</td>
                                                                        <td className="px-2 py-2 text-right font-bold text-brand-blue bg-gray-50">{monthEndStudents}</td>
                                                                        <td className="px-1"><input type="number" value={d.withdrawals ?? ''} onChange={(e)=>updatePlanData(m, 'withdrawals', e.target.value)} onFocus={(e) => e.target.select()} className="w-full border rounded px-1 py-1 text-right text-xs"/></td>
                                                                        <td className="px-1"><input type="number" value={d.touchTry ?? ''} onChange={(e)=>updatePlanData(m, 'touchTry', e.target.value)} onFocus={(e) => e.target.select()} className="w-full border rounded px-1 py-1 text-right text-xs"/></td>
                                                                        <td className="px-1"><input type="number" value={d.flyers ?? ''} onChange={(e)=>updatePlanData(m, 'flyers', e.target.value)} onFocus={(e) => e.target.select()} className="w-full border rounded px-1 py-1 text-right text-xs"/></td>
                                                                        <td className="px-1"><input type="number" value={d.trials ?? ''} onChange={(e)=>updatePlanData(m, 'trials', e.target.value)} onFocus={(e) => e.target.select()} className="w-full border rounded px-1 py-1 text-right text-xs"/></td>
                                                                        <td className="px-1"><input type="number" value={d.enrollments ?? ''} onChange={(e)=>updatePlanData(m, 'enrollments', e.target.value)} onFocus={(e) => e.target.select()} className="w-full border rounded px-1 py-1 text-right text-xs"/></td>
                                                                        <td className="px-2 py-2 text-right text-gray-500 text-xs">{rate}%</td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                </div>
                                                
                                                <div className="w-full">
                                                    <h4 className="font-bold text-gray-700 mb-2 border-l-4 border-brand-blue pl-2">2. 収支・PL計画</h4>
                                                    <table className="w-full text-xs text-left border-collapse">
                                                        <thead className="bg-gray-50 text-gray-500 font-medium border-b border-gray-200">
                                                            <tr>
                                                                <th className="px-2 py-2 whitespace-nowrap">月度</th>
                                                                <th className="px-1 py-2 text-center whitespace-nowrap">売上高</th>
                                                                <th className="px-1 py-2 text-center whitespace-nowrap">入会金</th>
                                                                <th className="px-1 py-2 text-center whitespace-nowrap">他売上</th>
                                                                <th className="px-1 py-2 text-center whitespace-nowrap">広告費</th>
                                                                <th className="px-1 py-2 text-center whitespace-nowrap">販売費</th>
                                                                <th className="px-1 py-2 text-center whitespace-nowrap">人件費</th>
                                                                <th className="px-1 py-2 text-center whitespace-nowrap">設備費</th>
                                                                <th className="px-1 py-2 text-center whitespace-nowrap">管理費</th>
                                                                <th className="px-2 py-2 whitespace-nowrap bg-gray-50">営業利益</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y divide-gray-100">
                                                            {MONTHS_LIST.map((m) => {
                                                                const d = planData[m] || {};
                                                                const revenueTotal = (Number(d.revenue)||0) + (Number(d.entranceFee)||0) + (Number(d.otherSales)||0);
                                                                const expenseTotal = (Number(d.adCost)||0) + (Number(d.salesCost)||0) + (Number(d.laborCost)||0) + (Number(d.facilityCost)||0) + (Number(d.adminCost)||0);
                                                                const profit = revenueTotal - expenseTotal;
                                                                return (
                                                                    <tr key={m} className="hover:bg-gray-50">
                                                                        <td className="px-2 py-2 font-bold text-gray-700">{m}</td>
                                                                        <td className="px-1"><input type="number" value={d.revenue ?? ''} onChange={(e)=>updatePlanData(m, 'revenue', e.target.value)} onFocus={(e) => e.target.select()} className="w-full border rounded px-1 py-1 text-right text-xs"/></td>
                                                                        <td className="px-1"><input type="number" value={d.entranceFee ?? ''} onChange={(e)=>updatePlanData(m, 'entranceFee', e.target.value)} onFocus={(e) => e.target.select()} className="w-full border rounded px-1 py-1 text-right text-xs"/></td>
                                                                        <td className="px-1"><input type="number" value={d.otherSales ?? ''} onChange={(e)=>updatePlanData(m, 'otherSales', e.target.value)} onFocus={(e) => e.target.select()} className="w-full border rounded px-1 py-1 text-right text-xs"/></td>
                                                                        <td className="px-1"><input type="number" value={d.adCost ?? ''} onChange={(e)=>updatePlanData(m, 'adCost', e.target.value)} onFocus={(e) => e.target.select()} className="w-full border rounded px-1 py-1 text-right text-xs"/></td>
                                                                        <td className="px-1"><input type="number" value={d.salesCost ?? ''} onChange={(e)=>updatePlanData(m, 'salesCost', e.target.value)} onFocus={(e) => e.target.select()} className="w-full border rounded px-1 py-1 text-right text-xs"/></td>
                                                                        <td className="px-1"><input type="number" value={d.laborCost ?? ''} onChange={(e)=>updatePlanData(m, 'laborCost', e.target.value)} onFocus={(e) => e.target.select()} className="w-full border rounded px-1 py-1 text-right text-xs"/></td>
                                                                        <td className="px-1"><input type="number" value={d.facilityCost ?? ''} onChange={(e)=>updatePlanData(m, 'facilityCost', e.target.value)} onFocus={(e) => e.target.select()} className="w-full border rounded px-1 py-1 text-right text-xs"/></td>
                                                                        <td className="px-1"><input type="number" value={d.adminCost ?? ''} onChange={(e)=>updatePlanData(m, 'adminCost', e.target.value)} onFocus={(e) => e.target.select()} className="w-full border rounded px-1 py-1 text-right text-xs"/></td>
                                                                        <td className={`px-2 py-2 text-right text-xs font-bold ${profit>=0 ? 'text-gray-700':'text-red-500'}`}>{profit.toLocaleString()}</td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        )}

                                        {/* 月度計画モード (週次) */}
                                        {planMode === 'monthly' && (
                                            <div>
                                                <div className="flex gap-1 mb-4 flex-wrap">
                                                    {MONTHS_LIST.map(m=><button key={m} onClick={()=>setSelectedMonth(m)} className={`text-sm px-3 py-1 rounded-full border ${selectedMonth===m?'bg-brand-orange text-white border-brand-orange':'bg-white text-gray-500 hover:bg-gray-50'}`}>{m}</button>)}
                                                </div>
                                                <div className="overflow-x-auto w-full">
                                                    <table className="w-full text-xs text-left border-collapse">
                                                        <thead className="bg-gray-50 text-gray-500 font-medium border-b border-gray-200">
                                                            <tr>
                                                                <th className="px-2 py-2 whitespace-nowrap">期間</th>
                                                                <th className="px-1 py-2 text-center whitespace-nowrap">T&T数</th>
                                                                <th className="px-1 py-2 text-center whitespace-nowrap">門配数</th>
                                                                <th className="px-1 py-2 text-center whitespace-nowrap">体験申込</th>
                                                                <th className="px-1 py-2 text-center whitespace-nowrap">体験実施</th>
                                                                <th className="px-1 py-2 text-center whitespace-nowrap">入会数</th>
                                                                <th className="px-2 py-2 text-right whitespace-nowrap">入会率</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y divide-gray-100">
                                                            {currentWeeksStruct.weeks.map((week, idx) => {
                                                                const weekData = planData[selectedMonth]?.weeks?.[idx] || {};
                                                                const rate = weekData.trialParticipation > 0 ? ((weekData.enrollments / weekData.trialParticipation) * 100).toFixed(1) : 0;
                                                                return (
                                                                    <tr key={idx} className="hover:bg-gray-50">
                                                                        <td className="px-2 py-2 font-bold text-gray-700">{week.label}</td>
                                                                        <td className="px-1"><input type="number" value={weekData.touchTry ?? ''} onChange={(e)=>updatePlanData(selectedMonth, 'touchTry', e.target.value, idx)} onFocus={(e) => e.target.select()} className="w-full bg-gray-50 border border-gray-200 rounded px-1 py-1 text-right focus:bg-white focus:ring-1 focus:ring-brand-orange outline-none"/></td>
                                                                        <td className="px-1"><input type="number" value={weekData.flyers ?? ''} onChange={(e)=>updatePlanData(selectedMonth, 'flyers', e.target.value, idx)} onFocus={(e) => e.target.select()} className="w-full bg-gray-50 border border-gray-200 rounded px-1 py-1 text-right focus:bg-white focus:ring-1 focus:ring-brand-orange outline-none"/></td>
                                                                        <td className="px-1"><input type="number" value={weekData.trialApp ?? ''} onChange={(e)=>updatePlanData(selectedMonth, 'trialApp', e.target.value, idx)} onFocus={(e) => e.target.select()} className="w-full bg-gray-50 border border-gray-200 rounded px-1 py-1 text-right focus:bg-white focus:ring-1 focus:ring-brand-orange outline-none"/></td>
                                                                        <td className="px-1"><input type="number" value={weekData.trialParticipation ?? ''} onChange={(e)=>updatePlanData(selectedMonth, 'trialParticipation', e.target.value, idx)} onFocus={(e) => e.target.select()} className="w-full bg-gray-50 border border-gray-200 rounded px-1 py-1 text-right focus:bg-white focus:ring-1 focus:ring-brand-orange outline-none"/></td>
                                                                        <td className="px-1"><input type="number" value={weekData.enrollments ?? ''} onChange={(e)=>updatePlanData(selectedMonth, 'enrollments', e.target.value, idx)} onFocus={(e) => e.target.select()} className="w-full bg-gray-50 border border-gray-200 rounded px-1 py-1 text-right focus:bg-white focus:ring-1 focus:ring-brand-orange outline-none"/></td>
                                                                        <td className="px-2 py-2 text-right text-gray-500 font-mono">{rate}%</td>
                                                                    </tr>
                                                                );
                                                            })}
                                                            <tr className="bg-gray-100 font-bold border-t-2 border-gray-300">
                                                                <td className="px-2 py-2 text-gray-700">合計</td>
                                                                <td className="px-1 py-2 text-right">{weeklyTotals.touchTry}</td>
                                                                <td className="px-1 py-2 text-right">{weeklyTotals.flyers}</td>
                                                                <td className="px-1 py-2 text-right">{weeklyTotals.trialApp}</td>
                                                                <td className="px-1 py-2 text-right">{weeklyTotals.trialParticipation}</td>
                                                                <td className="px-1 py-2 text-right">{weeklyTotals.enrollments}</td>
                                                                <td className="px-2 py-2 text-right">{weeklyTotals.trialParticipation > 0 ? ((weeklyTotals.enrollments / weeklyTotals.trialParticipation)*100).toFixed(1) : 0}%</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* データ取込タブ */}
                            {activeTab === 'import' && <CSVImportPanel />}

                            {/* 帳票出力タブ */}
                            {activeTab === 'report' && (
                                <div className="space-y-6 animate-in fade-in">
                                    <div className="bg-gray-50 p-6 rounded-xl border border-dashed border-gray-300">
                                        <div className="flex justify-between items-center mb-4 flex-wrap gap-4">
                                            <div className="flex items-center gap-4">
                                                <h3 className="font-bold text-gray-800 flex items-center"><Printer className="w-5 h-5 mr-2 text-brand-orange"/> レポート出力プレビュー</h3>
                                                
                                                {/* モード切替スイッチ */}
                                                <div className="flex bg-white rounded-lg p-1 border border-gray-200 shadow-sm">
                                                    <button 
                                                        onClick={() => setReportMode('monthly')}
                                                        className={`px-3 py-1.5 text-xs font-bold rounded-md transition-all ${reportMode === 'monthly' ? 'bg-brand-blue text-white shadow' : 'text-gray-500 hover:text-gray-700'}`}
                                                    >
                                                        月度レポート
                                                    </button>
                                                    <button 
                                                        onClick={() => setReportMode('annual')}
                                                        className={`px-3 py-1.5 text-xs font-bold rounded-md transition-all ${reportMode === 'annual' ? 'bg-brand-blue text-white shadow' : 'text-gray-500 hover:text-gray-700'}`}
                                                    >
                                                        年間計画表
                                                    </button>
                                                </div>

                                                {/* 月度選択 (月度モード時のみ表示) */}
                                                {reportMode === 'monthly' && (
                                                    <div className="flex gap-1 bg-white rounded-lg p-1 border border-gray-200">
                                                        {MONTHS_LIST.map(m => (
                                                            <button key={m} onClick={() => setSelectedMonth(m)} className={`text-xs px-2 py-1 rounded ${selectedMonth === m ? 'bg-brand-orange text-white' : 'text-gray-400 hover:bg-gray-50'}`}>{m}</button>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                            <button onClick={() => window.print()} className="bg-brand-blue text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-blue-700 flex items-center shadow-sm">
                                                <Printer className="w-4 h-4 mr-2"/> {reportMode === 'monthly' ? 'A4レポート印刷' : '計画表印刷(A4横)'}
                                            </button>
                                        </div>
                                        
                                        <div className="bg-gray-200 p-8 overflow-auto flex justify-center">
                                            <div className="shadow-lg transform scale-90 origin-top bg-white">
                                                {reportMode === 'monthly' ? (
                                                    <ReportView 
                                                        year={displayCalendarYear} 
                                                        month={selectedMonth} 
                                                        campus={campus} 
                                                        dailyData={currentMonthData.daily} 
                                                        weeklyData={currentMonthData.weekly} 
                                                        planData={calculatedPlanData} 
                                                        summaryData={{
                                                            students: currentMonthData.students,
                                                            newEnrollments: currentMonthData.newEnrollments,
                                                            withdrawals: currentMonthData.withdrawals
                                                        }}
                                                    />
                                                ) : (
                                                    <AnnualReportView 
                                                        year={selectedYear}
                                                        campus={campus}
                                                        planData={calculatedPlanData}
                                                    />
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'finance' && (
                                <div className="space-y-8 bg-white p-8 rounded-xl shadow-sm border border-gray-100 animate-in fade-in">
                                    <div className="flex justify-between items-center">
                                        <h3 className="text-lg font-bold text-gray-800 flex items-center"><FileSpreadsheet className="w-5 h-5 mr-2 text-brand-orange"/> 収支CSV取込 (横持ち形式)</h3>
                                        {lastUploadInfo && (
                                            <div className="flex items-center text-xs text-gray-500 bg-gray-50 px-3 py-1 rounded-full border border-gray-200">
                                                <Clock className="w-3 h-3 mr-1.5" />
                                                最終更新: <span className="font-bold ml-1">{lastUploadInfo.toLocaleString()}</span>
                                                <span className="ml-1 text-gray-400">({uploadTargetYear}年度)</span>
                                            </div>
                                        )}
                                    </div>
                                    {isAdmin ? (
                                        <>
                                            <div className="max-w-xl mx-auto"><CsvUploader onUpload={handleCsvUpload} isUploading={uploading} targetYear={uploadTargetYear} setTargetYear={setUploadTargetYear} /></div>
                                            <div className="text-sm text-gray-500 bg-gray-50 p-4 rounded-lg">
                                                <p className="font-bold mb-2">取込ルール:</p>
                                                <ul className="list-disc list-inside space-y-1">
                                                    <li><span className="font-bold text-red-500">重要:</span> 詳細分析のため「勘定コード」を保存します。以前のデータを上書き更新してください。</li>
                                                    <li>取り込みを実行すると、選択した年度の既存データは全て上書き(削除→再登録)されます。</li>
                                                    <li>5系:売上, 61:広告, 62:販売, 63:人件費, 64:設備, 65:管理, 69:本社 に自動分類されます。</li>
                                                </ul>
                                            </div>
                                        </>
                                    ) : (
                                        <div className="flex flex-col items-center justify-center py-20 text-gray-400 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                                            <Lock className="w-12 h-12 mb-4 text-gray-300" />
                                            <p className="font-bold text-lg">管理者権限が必要です</p>
                                            <p className="text-sm mt-2">収支データの取り込みを行うには、管理者モードでログインしてください。</p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

       // ==========================================
        // 5. HQ Console Component (修正版: 集客ファネルの門配・T&Tを積上げに変更)
        // ==========================================
        function HQConsole({ onBack, campusList, allData, selectedYear, setSelectedYear, refreshData, showNotify, isSyncing, lastUpdated, isUsingCache, isAdmin }) {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [viewMode, setViewMode] = useState('annual');
            const [selectedMonth, setSelectedMonth] = useState('4月');
            
            // 期間指定用のState (年月文字列 YYYY-MM)
            const [customStartMonth, setCustomStartMonth] = useState(() => {
                const d = new Date();
                const fy = d.getMonth() < 3 ? d.getFullYear() - 1 : d.getFullYear();
                return `${fy}-04`; 
            });
            const [customEndMonth, setCustomEndMonth] = useState(() => {
                const d = new Date();
                const m = ('0' + (d.getMonth() + 1)).slice(-2);
                return `${d.getFullYear()}-${m}`; 
            });

            // 現在の年月を取得（選択上限用）
            const currentMaxMonth = useMemo(() => {
                const d = new Date();
                return `${d.getFullYear()}-${('0' + (d.getMonth() + 1)).slice(-2)}`;
            }, []);

            const [newCampusName, setNewCampusName] = useState("");
            const [newCampusId, setNewCampusId] = useState("");
            const [selectedHQCampusId, setSelectedHQCampusId] = useState('All');
            const [plViewCategory, setPlViewCategory] = useState('all');
            const [hoveredData, setHoveredData] = useState(null);
            const [modalOpen, setModalOpen] = useState(false);
            const [modalData, setModalData] = useState([]);
            const [modalTitle, setModalTitle] = useState("");
            const [modalColor, setModalColor] = useState("");
            const [selectedPLItem, setSelectedPLItem] = useState(null);
            const [editModalOpen, setEditModalOpen] = useState(false);
            const [editingCampus, setEditingCampus] = useState(null);
            const [editName, setEditName] = useState("");
            const [editSheetName, setEditSheetName] = useState("");
            const [isReordering, setIsReordering] = useState(false);

            // 期間変更ハンドラ
            const handleCustomDateChange = (type, part, val) => {
                const base = type === 'start' ? customStartMonth : customEndMonth;
                let [y, m] = base.split('-').map(Number);

                if (part === 'year') y = Number(val);
                if (part === 'month') m = Number(val);

                const newVal = `${y}-${('0' + m).slice(-2)}`;

                if (type === 'start') {
                    setCustomStartMonth(newVal);
                    const [eY, eM] = customEndMonth.split('-').map(Number);
                    const diff = (eY - y) * 12 + (eM - m);
                    if (diff < 0) {
                        setCustomEndMonth(newVal);
                    } else if (diff >= 12) {
                        const d = new Date(y, m - 1 + 11, 1);
                        const fixedEnd = `${d.getFullYear()}-${('0' + (d.getMonth() + 1)).slice(-2)}`;
                        setCustomEndMonth(fixedEnd);
                    }
                } else {
                    setCustomEndMonth(newVal);
                    const [sY, sM] = customStartMonth.split('-').map(Number);
                    const diff = (y - sY) * 12 + (m - sM);
                    if (diff < 0) {
                        setCustomStartMonth(newVal);
                    } else if (diff >= 12) {
                        const d = new Date(y, m - 1 - 11, 1);
                        const fixedStart = `${d.getFullYear()}-${('0' + (d.getMonth() + 1)).slice(-2)}`;
                        setCustomStartMonth(fixedStart);
                    }
                }
            };

            const getFyFromYm = (ym) => {
                if (!ym) return 0;
                const [y, m] = ym.split('-').map(Number);
                return m < 4 ? y - 1 : y;
            };

            const filteredCampusList = useMemo(() => {
                if (selectedHQCampusId === 'All') return campusList;
                return campusList.filter(c => c.id === selectedHQCampusId);
            }, [selectedHQCampusId, campusList]);

            const fullDashboardData = useMemo(() => {
                return processDashboardData(filteredCampusList, allData.enrollments, allData.statusChanges, allData.transfers, allData.dailyReports, allData.financials, allData.trialApps, Number(selectedYear));
            }, [allData, filteredCampusList, selectedYear]);

            const displayData = useMemo(() => {
                if (viewMode === 'annual') return fullDashboardData;
                if (viewMode === 'half' || viewMode === 'quarter') return aggregatePeriod(fullDashboardData, viewMode);
                
                if (viewMode === 'custom') {
                    if (!customStartMonth || !customEndMonth) return fullDashboardData;
                    if (customStartMonth > customEndMonth) return [];

                    const startFy = getFyFromYm(customStartMonth);
                    const endFy = getFyFromYm(customEndMonth);
                    
                    let combinedData = [];
                    for (let y = startFy; y <= endFy; y++) {
                        const yearData = processDashboardData(
                            filteredCampusList, 
                            allData.enrollments, 
                            allData.statusChanges, 
                            allData.transfers, 
                            allData.dailyReports, 
                            allData.financials, 
                            allData.trialApps, 
                            y
                        );
                        
                        const labeledData = yearData.map((d, i) => {
                            let mNum = i + 4;
                            let mYear = y;
                            if (mNum > 12) { mNum -= 12; mYear += 1; }
                            const ym = `${mYear}-${('0' + mNum).slice(-2)}`;
                            return { ...d, ym };
                        });
                        combinedData = [...combinedData, ...labeledData];
                    }

                    const filtered = combinedData.filter(d => d.ym >= customStartMonth && d.ym <= customEndMonth);
                    return filtered.slice(0, 12);
                }

                const targetMonthData = fullDashboardData.find(m => m.name === selectedMonth);
                if (!targetMonthData) return [];

                if (viewMode === 'weekly') return targetMonthData.weekly || [];
                return targetMonthData.daily;
            }, [fullDashboardData, viewMode, selectedMonth, customStartMonth, customEndMonth, selectedYear, filteredCampusList, allData]);

            const monthDataForPL = useMemo(() => { return fullDashboardData.find(m => m.name === selectedMonth); }, [fullDashboardData, selectedMonth]);

            const marketingTotals = useMemo(() => {
                const sum = displayData.reduce((acc, curr) => ({
                    flyers: acc.flyers + (curr.flyers || 0),
                    touchTry: acc.touchTry + (curr.touchTry || 0),
                    trialApp: acc.trialApp + (curr.trialApp || 0),
                    eventApp: acc.eventApp + (curr.eventApp || 0),
                    trialActual: acc.trialActual + (curr.trialActual || 0),
                    newEnrollments: acc.newEnrollments + (curr.newEnrollments || 0),
                }), { flyers: 0, touchTry: 0, trialApp: 0, eventApp: 0, trialActual: 0, newEnrollments: 0 });

                const totalApps = sum.trialApp + sum.eventApp;
                const rate = sum.trialActual > 0 ? ((sum.newEnrollments / sum.trialActual) * 100).toFixed(1) : "0.0";

                return { ...sum, totalApps, rate };
            }, [displayData]);

            const totals = useMemo(() => {
                if (viewMode === 'monthly' && monthDataForPL) {
                    return {
                        revenue: monthDataForPL.revenue, prevRevenue: monthDataForPL.prevRevenue,
                        expense: monthDataForPL.expense, prevExpense: monthDataForPL.prevExpense,
                        profit: monthDataForPL.profit, prevProfit: monthDataForPL.prevProfit,
                        newEnrollments: monthDataForPL.newEnrollments, prevNewEnrollments: monthDataForPL.prevNewEnrollments,
                        withdrawals: monthDataForPL.withdrawals, prevWithdrawals: monthDataForPL.prevWithdrawals,
                        transferIns: monthDataForPL.transferIns, returns: monthDataForPL.returns,
                        graduates: Math.abs(monthDataForPL.graduates_neg || 0), transfers: Math.abs(monthDataForPL.transfers_neg || 0),
                        flyers: monthDataForPL.flyers, 
                        touchTry: monthDataForPL.touchTry,
                        trialApp: monthDataForPL.trialApp, 
                        trialScheduled: monthDataForPL.trialScheduled,
                        trialActual: monthDataForPL.trialActual, 
                        partTime: monthDataForPL.partTime || 0, students: monthDataForPL.students
                    };
                }
                return displayData.reduce((acc, curr) => ({
                    revenue: acc.revenue + (curr.revenue || 0), prevRevenue: acc.prevRevenue + (curr.prevRevenue || 0),
                    expense: acc.expense + (curr.expense || 0), prevExpense: acc.prevExpense + (curr.prevExpense || 0),
                    profit: acc.profit + (curr.profit || 0), prevProfit: acc.prevProfit + (curr.prevProfit || 0),
                    newEnrollments: acc.newEnrollments + (curr.newEnrollments || 0), prevNewEnrollments: acc.prevNewEnrollments + (curr.prevNewEnrollments || 0),
                    withdrawals: acc.withdrawals + (curr.withdrawals || 0), prevWithdrawals: acc.prevWithdrawals + (curr.prevWithdrawals || 0),
                    transferIns: acc.transferIns + (curr.transferIns || 0), returns: acc.returns + (curr.returns || 0),
                    graduates: acc.graduates + Math.abs(curr.graduates_neg || 0), transfers: acc.transfers + Math.abs(curr.transfers_neg || 0),
                    flyers: acc.flyers + (curr.flyers || 0), 
                    touchTry: acc.touchTry + (curr.touchTry || 0),
                    trialApp: acc.trialApp + (curr.trialApp || 0), 
                    trialScheduled: acc.trialScheduled + (curr.trialScheduled || 0),
                    trialActual: acc.trialActual + (curr.trialActual || 0), 
                    partTime: acc.partTime + (curr.partTime || 0)
                }), { 
                    revenue: 0, prevRevenue: 0, expense: 0, prevExpense: 0, profit: 0, prevProfit: 0, 
                    newEnrollments: 0, prevNewEnrollments: 0, withdrawals: 0, prevWithdrawals: 0,
                    transferIns: 0, returns: 0, graduates: 0, transfers: 0, flyers: 0, touchTry: 0, trialApp: 0, trialScheduled: 0, trialActual: 0, partTime: 0 
                });
            }, [displayData, viewMode, monthDataForPL]);
            
            const netIncrease = totals.newEnrollments - totals.withdrawals;
            const monthlySummaryData = useMemo(() => {
                if (viewMode !== 'monthly' || !monthDataForPL) return [];
                const data = [
                    { id: 'revenue', name: '売上', value: monthDataForPL.revenue, prev: monthDataForPL.prevRevenue, fill: COLORS.revenue },
                    { id: 'ad', name: '広告宣伝費', value: monthDataForPL.ad, prev: monthDataForPL.prevAd, fill: COLORS.ad },
                    { id: 'sales', name: '販売費', value: monthDataForPL.sales, prev: monthDataForPL.prevSales, fill: COLORS.sales },
                    { id: 'labor', name: '人件費', value: monthDataForPL.labor, prev: monthDataForPL.prevLabor, fill: COLORS.labor },
                    { id: 'facility', name: '設備費', value: monthDataForPL.facility, prev: monthDataForPL.prevFacility, fill: COLORS.facility },
                    { id: 'admin', name: '一般管理費', value: monthDataForPL.admin, prev: monthDataForPL.prevAdmin, fill: COLORS.admin },
                    { id: 'hq', name: '本社費', value: monthDataForPL.hq, prev: monthDataForPL.prevHq, fill: COLORS.hq },
                    { id: 'other', name: 'その他', value: monthDataForPL.other, prev: monthDataForPL.prevOther, fill: COLORS.other },
                    { id: 'profit', name: '営業利益', value: monthDataForPL.profit, prev: monthDataForPL.prevProfit, fill: COLORS.profit },
                ];
                return data;
            }, [monthDataForPL, viewMode]);

            const currentTotalStudents = useMemo(() => {
                if (viewMode === 'monthly') return monthDataForPL ? monthDataForPL.students : 0;
                if (viewMode === 'annual' || viewMode === 'half' || viewMode === 'quarter' || viewMode === 'custom') {
                    return displayData.length > 0 ? displayData[displayData.length - 1].students : 0;
                }
                const mData = fullDashboardData.find(m => m.name === selectedMonth);
                return mData ? mData.students : 0;
            }, [fullDashboardData, viewMode, selectedMonth, displayData, monthDataForPL]);

            const viewLabel = { 
                'annual': '年度', 'half': '半期', 'quarter': '四半期', 'monthly': '月度', 'weekly': '週次',
                'custom': `${customStartMonth}〜${customEndMonth}` 
            }[viewMode];

            const currentViewData = useMemo(() => {
                if (hoveredData) {
                    return {
                        ...hoveredData,
                        revenue: hoveredData.revenue || 0, prevRevenue: hoveredData.prevRevenue,
                        expense: hoveredData.expense || 0, prevExpense: hoveredData.prevExpense,
                        profit: hoveredData.profit || 0, prevProfit: hoveredData.prevProfit,
                        newEnrollments: hoveredData.newEnrollments || 0, prevNewEnrollments: hoveredData.prevNewEnrollments,
                        withdrawals: hoveredData.withdrawals || 0, prevWithdrawals: hoveredData.prevWithdrawals,
                        partTime: hoveredData.partTime || 0, totalStudents: hoveredData.students || 0, periodLabel: hoveredData.name
                    };
                } else {
                    return {
                        ...totals, totalStudents: currentTotalStudents, periodLabel: viewLabel === '月度' ? selectedMonth : viewLabel
                    };
                }
            }, [hoveredData, totals, currentTotalStudents, viewLabel, selectedMonth, viewMode]);

            const calcYoY = (curr, prev) => { if (!prev || prev === 0) return null; return ((curr / prev) * 100).toFixed(1); };
            const handleChartHover = (state) => { if (state && state.activePayload && state.activePayload.length > 0) { setHoveredData(state.activePayload[0].payload); } };
            const handleChartLeave = () => { setHoveredData(null); };
            const openDetailModal = (categoryKey, monthData) => {
                if (!monthData || !monthData.detailItems || !monthData.detailItems[categoryKey]) return;
                setModalTitle(`${monthData.name} - ${CATEGORY_MAP[categoryKey].label}`);
                setModalColor(CATEGORY_MAP[categoryKey].color); setModalData(monthData.detailItems[categoryKey]); setModalOpen(true);
            };
            const onBarClick = (data, idx, e, catKey) => { openDetailModal(catKey, data); };
            const handleAddCampus = async () => {
                if (!newCampusId || !newCampusName) return showNotify("必須項目が空です", 'error');
                try { await setDoc(doc(db, "campuses", newCampusId), { id: newCampusId, name: newCampusName, order: campusList.length, createdAt: serverTimestamp() }); setNewCampusId(""); setNewCampusName(""); refreshData(); showNotify("校舎を追加しました"); } catch(e) { showNotify("エラー: " + e.message, 'error'); }
            };
            const handleDeleteCampus = async (id, name) => {
                if (!confirm(`${name} を削除しますか？`)) return;
                try { await deleteDoc(doc(db, "campuses", id)); refreshData(); showNotify("校舎を削除しました"); } catch(e) { showNotify("エラー: " + e.message, 'error'); }
            };
            const openEditCampus = (campus) => { setEditingCampus(campus); setEditName(campus.name); setEditSheetName(campus.sheetName || ""); setEditModalOpen(true); };
            const handleUpdateCampus = async () => {
                if (!editingCampus) return;
                try { await updateDoc(doc(db, "campuses", editingCampus.id), { name: editName, sheetName: editSheetName, updatedAt: serverTimestamp() }); setEditModalOpen(false); setEditingCampus(null); refreshData(); showNotify("校舎情報を更新しました"); } catch (e) { showNotify("更新エラー: " + e.message, 'error'); }
            };
            const handleReorder = async (index, direction) => {
                const targetIndex = index + direction;
                if (targetIndex < 0 || targetIndex >= campusList.length) return;
                setIsReordering(true);
                try {
                    const batch = writeBatch(db);
                    const newList = [...campusList];
                    [newList[index], newList[targetIndex]] = [newList[targetIndex], newList[index]];
                    newList.forEach((item, idx) => { const ref = doc(db, "campuses", item.id); batch.update(ref, { order: idx }); });
                    await batch.commit(); refreshData(); showNotify("並び順を更新しました");
                } catch(e) { showNotify("並び替えエラー: " + e.message, 'error'); } finally { setIsReordering(false); }
            };
            const WeeklyAxisTick = ({ x, y, payload }) => {
                const item = displayData.find(d => d.name === payload.value);
                return (
                    <g transform={`translate(${x},${y})`}>
                        <text x={0} y={0} dy={16} textAnchor="middle" fill="#666" fontSize={12} fontWeight="bold">{payload.value}</text>
                        {item && item.label && <text x={0} y={0} dy={30} textAnchor="middle" fill="#94a3b8" fontSize={10}>{item.label}</text>}
                    </g>
                );
            };
            const plChartData = useMemo(() => {
                if (plViewCategory === 'all') return displayData;
                const uniqueKeys = new Set();
                const processed = displayData.map(d => {
                    const base = { name: d.name };
                    const items = d.detailItems ? d.detailItems[plViewCategory] || [] : [];
                    items.forEach(item => { base[item.name] = item.value; uniqueKeys.add(item.name); });
                    return base;
                });
                return { data: processed, keys: Array.from(uniqueKeys) };
            }, [displayData, plViewCategory]);
            const availableViewModes = ['annual', 'half', 'quarter', 'monthly'];
            if (activeTab === 'students') availableViewModes.push('weekly');
            const handlePLRowClick = (item) => { if (!monthDataForPL) return; if (item.id === 'revenue' || item.id === 'profit') return; setSelectedPLItem(item); };

            return (
                <div className="flex h-screen bg-brand-slate overflow-hidden fade-in">
                    <DetailModal isOpen={modalOpen} onClose={()=>setModalOpen(false)} data={modalData} title={modalTitle} color={modalColor} />
                    {editModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay backdrop-blur-sm transition-opacity" onClick={() => setEditModalOpen(false)}>
                            <div className="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 animate-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}>
                                {/* ... (編集モーダルの中身は変更なし) ... */}
                                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center"><Edit2 className="w-5 h-5 mr-2 text-brand-blue"/> 校舎情報の修正</h3>
                                <div className="space-y-4">
                                    <div><label className="block text-xs font-bold text-gray-500 mb-1">校舎ID (変更不可)</label><input type="text" value={editingCampus?.id} disabled className="w-full bg-gray-100 border border-gray-200 rounded px-3 py-2 text-gray-500 text-sm" /></div>
                                    <div><label className="block text-xs font-bold text-gray-500 mb-1">校舎名</label><input type="text" value={editName} onChange={e => setEditName(e.target.value)} className="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-brand-blue outline-none" /></div>
                                    <div><label className="block text-xs font-bold text-gray-500 mb-1">連携名 (Spreadsheet)</label><input type="text" value={editSheetName} onChange={e => setEditSheetName(e.target.value)} className="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-brand-blue outline-none" /></div>
                                    <div className="flex gap-3 pt-4">
                                        <button onClick={() => setEditModalOpen(false)} className="flex-1 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">キャンセル</button>
                                        <button onClick={handleUpdateCampus} className="flex-1 bg-brand-blue text-white py-2 rounded-lg hover:bg-blue-700">更新する</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    <aside className="w-64 bg-white border-r border-gray-200 flex flex-col z-10">
                        {/* ... (サイドバーは変更なし) ... */}
                        <div className="p-6 border-b border-gray-100 flex items-center space-x-3">
                            <div className="w-8 h-8 bg-brand-blue rounded flex items-center justify-center"><LayoutDashboard className="w-5 h-5 text-white" /></div>
                            <span className="font-bold text-lg text-gray-800">本部</span>
                        </div>
                        <nav className="flex-1 p-4 space-y-1">
                            {[{id:'dashboard',l:'サマリー',i:Activity}, {id:'pl',l:'収支・PL',i:DollarSign}, {id:'students',l:'生徒数',i:Users}, {id:'marketing',l:'マーケティング',i:Megaphone}, {id:'settings',l:'校舎管理',i:Settings}].map(t => {
                                if (t.id === 'settings' && !isAdmin) return null;
                                return (
                                    <button key={t.id} onClick={() => { setActiveTab(t.id); if(t.id !== 'students' && viewMode === 'weekly') setViewMode('monthly'); }} className={`w-full flex items-center px-4 py-3 rounded-lg transition-colors ${activeTab === t.id ? 'bg-brand-blue text-white shadow-md shadow-brand-blue/30' : 'text-gray-500 hover:bg-gray-50'}`}>
                                        <t.i className="w-5 h-5 mr-3" />{t.l}
                                    </button>
                                );
                            })}
                        </nav>
                        <div className="p-4 border-t border-gray-100 space-y-2">
                            <div className="text-xs text-gray-400 flex justify-between px-2"><span>{isUsingCache ? 'Cache' : 'Live'}</span><span>{lastUpdated ? lastUpdated.toLocaleTimeString() : '-'}</span></div>
                            <button onClick={onBack} className="flex items-center text-gray-400 hover:text-gray-600 text-sm w-full px-4 py-2"><LogOut className="w-4 h-4 mr-2" /> 戻る</button>
                        </div>
                    </aside>
                    <main className="flex-1 overflow-y-auto">
                        <header className="bg-white h-16 border-b border-gray-200 flex items-center justify-between px-8 sticky top-0 z-20">
                            <h2 className="text-xl font-bold text-gray-800">{{dashboard:'全校サマリー', pl:'収支・PL分析', students:'生徒数・入退会', marketing:'集客・ファネル', settings:'校舎マスタ管理'}[activeTab]}</h2>
                            <div className="flex items-center space-x-3">
                                {activeTab !== 'settings' && (
                                    <>
                                        <div className="flex items-center bg-gray-100 rounded-lg px-2 py-1 border border-gray-200 mr-2">
                                            <MapPin className="w-3 h-3 text-slate-500 mr-2" />
                                            <select value={selectedHQCampusId} onChange={(e) => setSelectedHQCampusId(e.target.value)} className="bg-transparent text-sm font-bold text-gray-700 outline-none cursor-pointer">
                                                <option value="All">全校舎 (合計)</option>
                                                {campusList.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                            </select>
                                        </div>
                                        <div className="flex bg-gray-100 rounded-lg p-1 border border-gray-200">
                                            {[...availableViewModes, 'custom'].map(m => (
                                                <button key={m} onClick={()=>setViewMode(m)} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${viewMode===m ? 'bg-white text-brand-blue shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>
                                                    {{annual:'年度', half:'半期', quarter:'四半期', monthly:'月度', weekly:'週次', custom:'期間指定'}[m]}
                                                </button>
                                            ))}
                                        </div>
                                        {(viewMode === 'monthly' || viewMode === 'weekly') && (
                                            <div className="flex items-center bg-gray-50 rounded-lg px-2 py-1 border border-gray-200">
                                                <select value={selectedMonth} onChange={(e)=>setSelectedMonth(e.target.value)} className="bg-transparent text-sm font-bold text-gray-700 outline-none cursor-pointer">
                                                    {MONTHS_LIST.map(m=><option key={m} value={m}>{m}</option>)}
                                                </select>
                                            </div>
                                        )}
                                        {/* 期間指定(custom)のプルダウン選択 (変更箇所) */}
                                        {viewMode === 'custom' && (
                                            <div className="flex items-center bg-gray-50 rounded-lg px-2 py-1 border border-gray-200 gap-2">
                                                <div className="flex items-center gap-1">
                                                    <select value={customStartMonth.split('-')[0]} onChange={(e) => handleCustomDateChange('start', 'year', e.target.value)} className="bg-transparent text-xs font-bold text-gray-700 outline-none cursor-pointer">
                                                        {YEARS_LIST.map(y => <option key={y} value={y}>{y}年</option>)}
                                                    </select>
                                                    <select value={parseInt(customStartMonth.split('-')[1])} onChange={(e) => handleCustomDateChange('start', 'month', e.target.value)} className="bg-transparent text-xs font-bold text-gray-700 outline-none cursor-pointer">
                                                        {Array.from({length:12}, (_,i)=>i+1).map(m => <option key={m} value={m}>{m}月</option>)}
                                                    </select>
                                                </div>
                                                <span className="text-gray-400 text-xs">〜</span>
                                                <div className="flex items-center gap-1">
                                                    <select value={customEndMonth.split('-')[0]} onChange={(e) => handleCustomDateChange('end', 'year', e.target.value)} className="bg-transparent text-xs font-bold text-gray-700 outline-none cursor-pointer">
                                                        {YEARS_LIST.map(y => <option key={y} value={y}>{y}年</option>)}
                                                    </select>
                                                    <select value={parseInt(customEndMonth.split('-')[1])} onChange={(e) => handleCustomDateChange('end', 'month', e.target.value)} className="bg-transparent text-xs font-bold text-gray-700 outline-none cursor-pointer">
                                                        {Array.from({length:12}, (_,i)=>i+1).map(m => <option key={m} value={m}>{m}月</option>)}
                                                    </select>
                                                </div>
                                            </div>
                                        )}
                                    </>
                                )}
                                <select value={selectedYear} onChange={(e)=>setSelectedYear(e.target.value)} className="bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5 text-sm font-bold text-gray-600 focus:ring-2 focus:ring-brand-blue outline-none">
                                    {YEARS_LIST.map(y => <option key={y} value={y}>{y}年度</option>)}
                                </select>
                                <button onClick={refreshData} disabled={isSyncing} className={`p-2 rounded-lg border border-gray-200 transition-all ${isSyncing ? 'bg-blue-50 text-blue-600' : 'bg-white hover:bg-gray-50 text-gray-600'}`}><RefreshCw className={`w-4 h-4 ${isSyncing ? 'animate-spin' : ''}`} /></button>
                            </div>
                        </header>
                        <div className="p-8 max-w-7xl mx-auto">
                            {/* ... (メインコンテンツ部分は変更なし) ... */}
                            {activeTab === 'dashboard' && (
                                <div className="space-y-8 animate-in fade-in">
                                    <div className="grid grid-cols-1 md:grid-cols-6 gap-4">
                                        <StatCard title="売上" value={formatYen(currentViewData.revenue)} subValue={currentViewData.periodLabel} yoy={calcYoY(currentViewData.revenue, currentViewData.prevRevenue)} iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_1eb00716-6ac0-4be4-9b78-e8e9be44198e.svg" colorClass="text-brand-blue" />
                                        <StatCard title="費用" value={formatYen(currentViewData.expense)} subValue={currentViewData.periodLabel} yoy={calcYoY(currentViewData.expense, currentViewData.prevExpense)} iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_72e22ba6-81fa-4b3e-abf5-23d886ad1dea.svg" colorClass="text-rose-500" />
                                        <StatCard title="営業利益" value={formatYen(currentViewData.profit)} subValue={currentViewData.periodLabel} yoy={calcYoY(currentViewData.profit, currentViewData.prevProfit)} iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_33bb072f-fe8f-4a20-8e5a-0bc5f53bde3d.svg" colorClass="text-emerald-500" />
                                        <StatCard title="入会数" value={`${currentViewData.newEnrollments}名`} subValue={currentViewData.periodLabel} yoy={calcYoY(currentViewData.newEnrollments, currentViewData.prevNewEnrollments)} iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_c7c5b948-913f-4f31-903b-c8a91774107f.svg" colorClass="text-emerald-500" />
                                        <StatCard title="退会数" value={`${currentViewData.withdrawals}名`} subValue={currentViewData.periodLabel} yoy={calcYoY(currentViewData.withdrawals, currentViewData.prevWithdrawals)} iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_28d76d55-88ab-48e9-b098-dc838ba040c2.svg" colorClass="text-rose-500" />
                                        <StatCard title="在籍生徒数" value={`${currentViewData.totalStudents}名`} subValue="期間末" iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_cd586213-916c-4b50-b0c3-deb64e7fdd8a.svg" colorClass="text-brand-blue" />
                                    </div>
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-96">
                                            <h3 className="text-lg font-bold text-gray-800 mb-6 flex items-center"><DollarSign className="w-5 h-5 mr-2 text-brand-blue"/> 収支サマリー ({viewLabel})</h3>
                                            <ResponsiveContainer width="100%" height="90%">
                                                {viewMode === 'monthly' ? (
                                                    <BarChart data={monthlySummaryData} layout="vertical" margin={{left: 20}}>
                                                        <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                                                        <XAxis type="number" />
                                                        <YAxis dataKey="name" type="category" width={80} />
                                                        <Tooltip formatter={(value)=>formatYen(value)} />
                                                        <Bar dataKey="value" name="金額" radius={[0, 4, 4, 0]}>
                                                            {monthlySummaryData.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.fill} />)}
                                                        </Bar>
                                                    </BarChart>
                                                ) : (
                                                    <ComposedChart data={displayData} onMouseMove={handleChartHover} onMouseLeave={handleChartLeave}>
                                                        <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                        <XAxis dataKey="name" interval={0} />
                                                        <YAxis />
                                                        <Tooltip formatter={(value)=>formatYen(value)} />
                                                        <Legend />
                                                        <Bar dataKey="revenue" name="売上" fill={COLORS.revenue} barSize={20} />
                                                        <Bar dataKey="expense" name="費用" fill={COLORS.labor} barSize={20} />
                                                        <Line type="monotone" dataKey="profit" name="営業利益" stroke={COLORS.profit} strokeWidth={3} />
                                                    </ComposedChart>
                                                )}
                                            </ResponsiveContainer>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-96">
                                            <h3 className="text-lg font-bold text-gray-800 mb-6 flex items-center"><Users className="w-5 h-5 mr-2 text-brand-orange"/> 生徒数推移 (増減要因)</h3>
                                            <ResponsiveContainer width="100%" height="90%">
                                                <BarChart data={displayData} stackOffset="sign" onMouseMove={handleChartHover} onMouseLeave={handleChartLeave}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                    <XAxis dataKey="name" interval={0} />
                                                    <YAxis />
                                                    <Tooltip />
                                                    <Legend />
                                                    <ReferenceLine y={0} stroke="#000" />
                                                    <Bar dataKey="newEnrollments" name="入会" fill="#10B981" stackId="stack" />
                                                    <Bar dataKey="transferIns" name="転入" fill="#06B6D4" stackId="stack" />
                                                    <Bar dataKey="withdrawals_neg" name="退会" fill="#EF4444" stackId="stack" />
                                                    <Bar dataKey="graduates_neg" name="卒業" fill="#A855F7" stackId="stack" />
                                                    <Bar dataKey="transfers_neg" name="転校" fill="#F97316" stackId="stack" />
                                                </BarChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {activeTab === 'pl' && (
                                <div className="space-y-8 animate-in fade-in">
                                    {/* ... (PLタブの内容は変更なし) ... */}
                                    <div className="grid grid-cols-1 md:grid-cols-5 gap-6">
                                        <StatCard title="売上" value={formatYen(currentViewData.revenue)} subValue={currentViewData.periodLabel} yoy={calcYoY(currentViewData.revenue, currentViewData.prevRevenue)} iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_1eb00716-6ac0-4be4-9b78-e8e9be44198e.svg" colorClass="text-brand-blue" />
                                        <StatCard title="費用" value={formatYen(currentViewData.expense)} subValue={currentViewData.periodLabel} yoy={calcYoY(currentViewData.expense, currentViewData.prevExpense)} iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_72e22ba6-81fa-4b3e-abf5-23d886ad1dea.svg" colorClass="text-rose-500" />
                                        <StatCard title="営業利益" value={formatYen(currentViewData.profit)} subValue={currentViewData.periodLabel} yoy={calcYoY(currentViewData.profit, currentViewData.prevProfit)} iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_33bb072f-fe8f-4a20-8e5a-0bc5f53bde3d.svg" colorClass="text-emerald-500" />
                                        <StatCard title="アルバイト人件費率" value={`${currentViewData.revenue > 0 ? (currentViewData.partTime / currentViewData.revenue * 100).toFixed(1) : 0}%`} subValue="売上比" iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_f93e0546-f8d7-464b-b008-882ad339027e.svg" colorClass="text-rose-500" />
                                        <StatCard title="利益率" value={`${currentViewData.revenue ? ((currentViewData.profit/currentViewData.revenue)*100).toFixed(1) : 0}%`} subValue="売上対比" iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_d71099f5-a933-4295-9991-75c16e130f81.svg" colorClass="text-brand-orange" />
                                    </div>
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-[500px]">
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="text-lg font-bold text-gray-800 flex items-center"><DollarSign className="w-5 h-5 mr-2 text-brand-blue"/> 詳細収支推移 ({viewLabel})</h3>
                                            <div className="flex items-center space-x-2">
                                                <span className="text-xs text-gray-500">表示科目:</span>
                                                <select value={plViewCategory} onChange={(e) => setPlViewCategory(e.target.value)} className="text-xs border border-gray-300 rounded px-2 py-1 outline-none">
                                                    <option value="all">全体 (サマリー)</option>
                                                    <option value="revenue">売上</option>
                                                    <option value="ad">広告宣伝費</option>
                                                    <option value="sales">販売費</option>
                                                    <option value="labor">人件費</option>
                                                    <option value="facility">設備費</option>
                                                    <option value="admin">一般管理費</option>
                                                    <option value="hq">本社費</option>
                                                </select>
                                            </div>
                                        </div>
                                        {viewMode === 'monthly' ? (
                                            <div className="grid grid-cols-2 gap-8 h-full">
                                                 <div className="overflow-x-auto h-full">
                                                    <table className="w-full text-sm">
                                                        <thead className="bg-gray-50 text-gray-500 font-medium">
                                                            <tr><th className="px-4 py-2 text-left">科目</th><th className="px-4 py-2 text-right">実績</th><th className="px-4 py-2 text-right">売上比</th><th className="px-4 py-2 text-right">前年</th><th className="px-4 py-2 text-right">前年比</th></tr>
                                                        </thead>
                                                        <tbody className="divide-y divide-gray-100">
                                                            {monthlySummaryData.map((item) => {
                                                                const isProfit = item.id === 'profit';
                                                                const ratio = monthlySummaryData[0].value > 0 ? (item.value / monthlySummaryData[0].value * 100).toFixed(1) : '-';
                                                                const yoy = item.prev > 0 ? ((item.value - item.prev) / item.prev * 100).toFixed(1) : '-';
                                                                return (
                                                                    <tr key={item.id} onClick={() => handlePLRowClick(item)} className={`hover:bg-blue-50 cursor-pointer ${selectedPLItem?.id === item.id ? 'bg-blue-50' : ''}`}>
                                                                        <td className="px-4 py-3 font-bold text-gray-700 flex items-center"><div className="w-3 h-3 rounded-full mr-2" style={{backgroundColor: item.fill}}></div>{item.name}</td>
                                                                        <td className="px-4 py-3 text-right">{formatYen(item.value)}</td>
                                                                        <td className="px-4 py-3 text-right text-gray-500">{ratio}%</td>
                                                                        <td className="px-4 py-3 text-right text-gray-400">{formatYen(item.prev)}</td>
                                                                        <td className={`px-4 py-3 text-right font-bold ${yoy > 0 ? (isProfit ? 'text-emerald-600' : 'text-rose-600') : (isProfit ? 'text-rose-600' : 'text-emerald-600')}`}>{yoy !== '-' ? yoy + '%' : '-'}</td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div className="h-full flex flex-col">
                                                     {selectedPLItem ? (
                                                         <>
                                                            <h3 className="text-lg font-bold text-gray-800 mb-2">{selectedPLItem.name} 詳細</h3>
                                                            <div className="flex-1 overflow-y-auto">
                                                                {monthDataForPL.detailItems[selectedPLItem.id]?.map((d, i) => (
                                                                    <div key={i} className="flex justify-between p-2 border-b border-gray-50 text-sm"><span>{d.name}</span><span>{formatYen(d.value)}</span></div>
                                                                ))}
                                                            </div>
                                                         </>
                                                     ) : <div className="flex items-center justify-center h-full text-gray-400">科目を選択してください</div>}
                                                </div>
                                            </div>
                                        ) : (
                                            <ResponsiveContainer width="100%" height="90%">
                                                {plViewCategory === 'all' ? (
                                                    <ComposedChart data={displayData} stackOffset="sign" onMouseMove={handleChartHover} onMouseLeave={handleChartLeave}>
                                                        <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                        <XAxis dataKey="name" interval={0} />
                                                        <YAxis />
                                                        <Tooltip formatter={(value)=>formatYen(value)} />
                                                        <Legend />
                                                        <Bar dataKey="ad" name="広告宣伝費" stackId="exp" fill={COLORS.ad} onClick={(data, i) => onBarClick(data, i, null, 'ad')} cursor="pointer"/>
                                                        <Bar dataKey="sales" name="販売費" stackId="exp" fill={COLORS.sales} onClick={(data, i) => onBarClick(data, i, null, 'sales')} cursor="pointer"/>
                                                        <Bar dataKey="labor" name="人件費" stackId="exp" fill={COLORS.labor} onClick={(data, i) => onBarClick(data, i, null, 'labor')} cursor="pointer"/>
                                                        <Bar dataKey="facility" name="設備費" stackId="exp" fill={COLORS.facility} onClick={(data, i) => onBarClick(data, i, null, 'facility')} cursor="pointer"/>
                                                        <Bar dataKey="admin" name="一般管理費" stackId="exp" fill={COLORS.admin} onClick={(data, i) => onBarClick(data, i, null, 'admin')} cursor="pointer"/>
                                                        <Bar dataKey="hq" name="本社費" stackId="exp" fill={COLORS.hq} onClick={(data, i) => onBarClick(data, i, null, 'hq')} cursor="pointer"/>
                                                        <Bar dataKey="other" name="その他" stackId="exp" fill={COLORS.other} onClick={(data, i) => onBarClick(data, i, null, 'other')} cursor="pointer"/>
                                                        <Line type="monotone" dataKey="revenue" name="売上" stroke={COLORS.revenue} strokeWidth={3} />
                                                        <Line type="monotone" dataKey="profit" name="営業利益" stroke={COLORS.profit} strokeWidth={2} strokeDasharray="5 5" />
                                                    </ComposedChart>
                                                ) : (
                                                    <BarChart data={plChartData.data}>
                                                        <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                        <XAxis dataKey="name" interval={0} />
                                                        <YAxis />
                                                        <Tooltip formatter={(value)=>formatYen(value)} />
                                                        <Legend />
                                                        {plChartData.keys.map((key, index) => (
                                                            <Bar key={key} dataKey={key} stackId="a" fill={SUB_COLORS[index % SUB_COLORS.length]} />
                                                        ))}
                                                    </BarChart>
                                                )}
                                            </ResponsiveContainer>
                                        )}
                                    </div>
                                </div>
                            )}
                            {activeTab === 'students' && (
                                <div className="space-y-8 animate-in fade-in">
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                        <StatCard 
                                            title="期間内増加" 
                                            value={`${totals.newEnrollments + totals.transferIns}名`} 
                                            subValue="入会+転入" 
                                            iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_d71099f5-a933-4295-9991-75c16e130f81.svg" 
                                            colorClass="text-emerald-500" 
                                            details={[{label:'入会', value:totals.newEnrollments}, {label:'転入', value:totals.transferIns}]} 
                                        />
                                        <StatCard 
                                            title="期間内減少" 
                                            value={`${totals.withdrawals + Math.abs(totals.transfers) + Math.abs(totals.graduates)}名`} 
                                            subValue="退会+転校+卒業" 
                                            iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_c22e686d-38dc-4fb6-bcf8-dc71adcf9d99.svg" 
                                            colorClass="text-rose-500" 
                                            details={[{label:'退会', value:totals.withdrawals}, {label:'転校', value:Math.abs(totals.transfers)}, {label:'卒業', value:Math.abs(totals.graduates)}]} 
                                        />
                                        <StatCard 
                                            title="純増数" 
                                            value={`${netIncrease > 0 ? '+' : ''}${netIncrease}名`} 
                                            subValue="入会 - 退会" 
                                            iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_c7c5b948-913f-4f31-903b-c8a91774107f.svg" 
                                            colorClass={netIncrease >= 0 ? "text-emerald-500" : "text-rose-500"} 
                                        />
                                        <StatCard 
                                            title="在籍生徒数" 
                                            value={`${currentTotalStudents}名`} 
                                            subValue={viewMode==='annual'?'年度末':'月末'} 
                                            iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_cd586213-916c-4b50-b0c3-deb64e7fdd8a.svg" 
                                            colorClass="text-brand-blue" 
                                        />
                                    </div>
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-[500px]">
                                        <h3 className="text-lg font-bold text-gray-800 mb-6">生徒数増減詳細 (折れ線: 在籍生徒数)</h3>
                                        <ResponsiveContainer width="100%" height="100%">
                                            <ComposedChart data={displayData} stackOffset="sign">
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                <XAxis dataKey="name" interval={0} tick={viewMode === 'weekly' ? WeeklyAxisTick : undefined} />
                                                <YAxis yAxisId="left" />
                                                <YAxis yAxisId="right" orientation="right" />
                                                <Tooltip />
                                                <Legend />
                                                <ReferenceLine y={0} stroke="#000" yAxisId="left" />
                                                <Bar yAxisId="left" dataKey="newEnrollments" name="入会" fill="#10b981" stackId="stack" />
                                                <Bar yAxisId="left" dataKey="transferIns" name="転入" fill="#06B6D4" stackId="stack" />
                                                <Bar yAxisId="left" dataKey="withdrawals_neg" name="退会" fill="#EF4444" stackId="stack" />
                                                <Bar yAxisId="left" dataKey="graduates_neg" name="卒業" fill="#A855F7" stackId="stack" />
                                                <Bar yAxisId="left" dataKey="transfers_neg" name="転校" fill="#F97316" stackId="stack" />
                                                <Line yAxisId="right" type="monotone" dataKey="students" name="在籍生徒数" stroke="#1E51A2" strokeWidth={3} dot={{r: 4}} />
                                            </ComposedChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'marketing' && (
                                <div className="space-y-8 animate-in fade-in">
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                                        <StatCard title="門配数" value={Number(marketingTotals.flyers).toLocaleString()} subValue="枚" iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_c2a71fb3-8a17-487f-9a43-8bbaf4fd5dbc.svg" colorClass="text-brand-blue" />
                                        <StatCard title="T&T数" value={`${marketingTotals.touchTry}名`} subValue="回" iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_c70b5f6d-6213-489c-bd5e-e3f6ce379f23.svg" colorClass="text-emerald-500" />
                                        <StatCard
                                            title="体験・イベント申込"
                                            value={`${marketingTotals.totalApps}名`}
                                            subValue={`体験:${marketingTotals.trialApp} / イベ:${marketingTotals.eventApp}`}
                                            iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-1523x1551_v-fms_webp_aac06d68-945a-47cb-95d6-19c1f545a656.png"
                                            colorClass="text-brand-blue"
                                        />
                                        <StatCard title="体験会実施" value={`${marketingTotals.trialActual}名`} subValue="回" iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_8a59c5ac-e140-4c01-a48b-c32bbeec5af0.svg" colorClass="text-brand-orange" />
                                        <StatCard title="入会数" value={`${marketingTotals.newEnrollments}名`} subValue="人" iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_963a0f4f-287f-4143-8c66-6c301ca67ae8.svg" colorClass="text-emerald-600" />
                                        <StatCard title="入会率" value={`${marketingTotals.rate}%`} subValue="入会 ÷ 実施" iconUrl="https://storage.googleapis.com/studio-design-asset-files/projects/nBW2jZ2ZWv/s-150x150_d71099f5-a933-4295-9991-75c16e130f81.svg" colorClass="text-rose-500" />
                                    </div>

                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-[500px]">
                                        <h3 className="text-lg font-bold text-gray-800 mb-6">集客ファネル推移 ({viewLabel})</h3>
                                        <ResponsiveContainer width="100%" height="100%">
                                            <ComposedChart data={displayData}>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                <XAxis dataKey="name" interval={0} tick={viewMode === 'weekly' ? WeeklyAxisTick : undefined} />
                                                <YAxis yAxisId="left" orientation="left" />
                                                <YAxis yAxisId="right" orientation="right" />
                                                <Tooltip />
                                                <Legend />
                                                <Bar yAxisId="left" dataKey="flyers" name="門配数" stackId="contact" fill="#94a3b8" />
                                                <Bar yAxisId="left" dataKey="touchTry" name="T&T数" stackId="contact" fill="#82ca9d" />
                                                
                                                <Bar yAxisId="right" dataKey="trialApp" name="体験申込" stackId="app" fill="#3b82f6" />
                                                <Bar yAxisId="right" dataKey="eventApp" name="イベント申込" stackId="app" fill="#93c5fd" />
                                                
                                                {/* 実施予約を体験とイベントに分割して積み上げ */}
                                                <Bar yAxisId="right" dataKey="trialScheduled" name="体験予約" stackId="sch" fill="#facc15" />
                                                <Bar yAxisId="right" dataKey="eventScheduled" name="イベント予約" stackId="sch" fill="#fde047" />
                                                
                                                <Bar yAxisId="right" dataKey="trialActual" name="体験実施" fill="#f97316" />
                                                
                                                <Line yAxisId="right" type="monotone" dataKey="newEnrollments" name="入会数" stroke="#10b981" strokeWidth={3} />
                                            </ComposedChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                            )}
                            
                            {activeTab === 'settings' && (
                                <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-100">
                                    <h3 className="text-lg font-bold text-gray-800 mb-6">登録済み校舎 ({campusList.length})</h3>
                                    <div className="flex gap-4 items-end mb-10">
                                        <div className="flex-1"><label className="block text-sm font-bold text-gray-700 mb-2">ID (英数)</label><input type="text" value={newCampusId} onChange={e=>setNewCampusId(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-brand-blue" placeholder="shibuya"/></div>
                                        <div className="flex-1"><label className="block text-sm font-bold text-gray-700 mb-2">校舎名</label><input type="text" value={newCampusName} onChange={e=>setNewCampusName(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-brand-blue" placeholder="渋谷校"/></div>
                                        <button onClick={handleAddCampus} className="bg-brand-blue text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700">登録</button>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {campusList.map((c, index)=>(
                                            <div key={c.id} className="p-4 border border-gray-200 rounded-lg bg-gray-50 flex justify-between items-center group hover:shadow-md transition-shadow">
                                                <div><div className="font-bold text-gray-700">{c.name}</div><div className="text-xs text-gray-400">{c.id}</div></div>
                                                <div className="flex items-center gap-2">
                                                    <div className="flex gap-1 mr-2 opacity-50 group-hover:opacity-100 transition-opacity">
                                                        <button onClick={() => handleReorder(index, -1)} disabled={index === 0 || isReordering} className="p-1 hover:text-brand-blue disabled:opacity-20"><ArrowUp className="w-4 h-4"/></button>
                                                        <button onClick={() => handleReorder(index, 1)} disabled={index === campusList.length - 1 || isReordering} className="p-1 hover:text-brand-blue disabled:opacity-20"><ArrowDown className="w-4 h-4"/></button>
                                                    </div>
                                                    <button onClick={() => openEditCampus(c)} className="text-gray-400 hover:text-brand-blue p-2"><Edit2 className="w-4 h-4"/></button>
                                                    <button onClick={() => handleDeleteCampus(c.id, c.name)} className="text-gray-400 hover:text-red-500 p-2"><Trash2 className="w-4 h-4"/></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        // ==========================================
        // 6. App Component
        // ==========================================
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [consoleMode, setConsoleMode] = useState('select'); 
            const [selectedCampusId, setSelectedCampusId] = useState(null);
            const [campusList, setCampusList] = useState([]);
            // 現在日付から初期年度を自動判定 (1-3月なら前年が年度)
            const [selectedYear, setSelectedYear] = useState(() => { const d = new Date(); return d.getMonth() < 3 ? d.getFullYear() - 1 : d.getFullYear(); });
            const [notification, setNotification] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);
            const [lastUpdated, setLastUpdated] = useState(null);
            const [isUsingCache, setIsUsingCache] = useState(false);
            const [allData, setAllData] = useState({ enrollments: [], statusChanges: [], transfers: [], dailyReports: [], financials: [], trialApps: [], financialUpdates: [] });
            
            // 管理者モード・認証用ステート
            const [isAdmin, setIsAdmin] = useState(false);
            const [showAdminAuth, setShowAdminAuth] = useState(false);
            const [adminPasswordInput, setAdminPasswordInput] = useState("");

            useEffect(() => {
                const auth = getAuth();
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleLogout = async () => {
                const auth = getAuth();
                await signOut(auth);
            };

            const showNotify = (msg, type='success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            const loadFromCache = () => {
                try {
                    const cCamp = localStorage.getItem(CACHE_KEYS.CAMPUSES);
                    const cData = localStorage.getItem(CACHE_KEYS.ALL_DATA);
                    const cTime = localStorage.getItem(CACHE_KEYS.LAST_UPDATED);
                    if (cCamp && cData) {
                        setCampusList(JSON.parse(cCamp));
                        setAllData(JSON.parse(cData));
                        if (cTime) setLastUpdated(new Date(cTime));
                        setIsUsingCache(true);
                        return true;
                    }
                } catch (e) { console.error(e); }
                return false;
            };

            const fetchData = async (forceUpdate = false) => {
                if (!isFirebaseInitialized) return;
                if (!forceUpdate && loadFromCache()) return;
                setIsSyncing(true);
                try {
                    const [campuses, enroll, status, trans, reports, finance, trials, finUpdates] = await Promise.all([
                        getDocs(query(collection(db, "campuses"), orderBy("createdAt"))),
                        getDocs(collection(db, "enrollments")),
                        getDocs(collection(db, "status_changes")),
                        getDocs(collection(db, "transfers")),
                        getDocs(collection(db, "daily_reports")),
                        getDocs(collection(db, "financials")),
                        getDocs(collection(db, "trial_applications")),
                        getDocs(collection(db, "financial_updates"))
                    ]);
                    
                    const cList = campuses.docs.map(d => ({ id: d.id, ...d.data() }));
                    cList.sort((a, b) => {
                        const orderA = typeof a.order === 'number' ? a.order : 9999;
                        const orderB = typeof b.order === 'number' ? b.order : 9999;
                        if (orderA !== orderB) return orderA - orderB;
                        
                        const timeA = a.createdAt?.seconds || 0;
                        const timeB = b.createdAt?.seconds || 0;
                        return timeA - timeB;
                    });

                    const aData = {
                        enrollments: enroll.docs.map(d => ({id:d.id, ...d.data()})),
                        statusChanges: status.docs.map(d => ({id:d.id, ...d.data()})),
                        transfers: trans.docs.map(d => ({id:d.id, ...d.data()})),
                        dailyReports: reports.docs.map(d => ({id:d.id, ...d.data()})),
                        financials: finance.docs.map(d => ({id:d.id, ...d.data()})),
                        trialApps: trials.docs.map(d => {
                            const data = d.data();
                            return {
                                id: d.id,
                                campus: data.campus, 
                                date: data.date,     
                                trialDate: data.trialDate, 
                                type: data.type,     
                                createdAt: data.createdAt
                            };
                        }),
                        financialUpdates: finUpdates.docs.map(d => ({id:d.id, ...d.data()}))
                    };
                    setCampusList(cList);
                    setAllData(aData);
                    localStorage.setItem(CACHE_KEYS.CAMPUSES, JSON.stringify(cList));
                    localStorage.setItem(CACHE_KEYS.ALL_DATA, JSON.stringify(aData));
                    const now = new Date();
                    localStorage.setItem(CACHE_KEYS.LAST_UPDATED, now.toISOString());
                    setLastUpdated(now);
                    setIsUsingCache(false);
                    if (forceUpdate) showNotify("データを更新しました");
                } catch (e) { console.error(e); showNotify("データ取得エラー", 'error'); } finally { setIsSyncing(false); }
            };

            useEffect(() => { 
                if (user) fetchData(); 
            }, [user]);

            const handleRefresh = () => fetchData(true);
            const handleEnterHQ = () => setConsoleMode('hq');
            const handleEnterSchool = (id) => { setSelectedCampusId(id); setConsoleMode('school'); };
            const handleBack = () => { setConsoleMode('select'); setSelectedCampusId(null); };
            
            // 追加: マイページへの遷移
            const handleMyPage = () => setConsoleMode('mypage');

            // 管理者モード切替ロジック
            const handleAdminToggle = () => {
                if (isAdmin) {
                    setIsAdmin(false);
                    showNotify("管理者モードを終了しました");
                } else {
                    setShowAdminAuth(true);
                    setAdminPasswordInput("");
                }
            };

            const handleAdminLogin = () => {
                if (adminPasswordInput === "admin") {
                    setIsAdmin(true);
                    setShowAdminAuth(false);
                    showNotify("管理者モードでログインしました");
                } else {
                    showNotify("パスワードが違います", "error");
                }
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center"><Loader2 className="w-10 h-10 animate-spin text-brand-blue" /></div>;
            if (!user) return <Login />;

            return (
                <>
                    <Notification msg={notification?.msg} type={notification?.type} onClose={()=>setNotification(null)} />
                    
                    {/* 管理者認証モーダル */}
                    {showAdminAuth && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay backdrop-blur-sm transition-opacity" onClick={() => setShowAdminAuth(false)}>
                            <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 animate-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center"><Shield className="w-5 h-5 mr-2 text-brand-blue"/> 管理者認証</h3>
                                <p className="text-sm text-gray-500 mb-4">パスワードを入力してください</p>
                                <input 
                                    type="password" 
                                    value={adminPasswordInput}
                                    onChange={(e) => setAdminPasswordInput(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && handleAdminLogin()}
                                    className="w-full border border-gray-300 rounded px-3 py-2 mb-4 focus:ring-2 focus:ring-brand-blue outline-none"
                                    autoFocus
                                />
                                <div className="flex gap-2">
                                    <button onClick={() => setShowAdminAuth(false)} className="flex-1 py-2 text-gray-500 hover:bg-gray-100 rounded-lg text-sm font-bold">キャンセル</button>
                                    <button onClick={handleAdminLogin} className="flex-1 bg-brand-blue text-white py-2 rounded-lg hover:bg-blue-700 text-sm font-bold">認証</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {consoleMode === 'select' && (
                        <div className="min-h-screen bg-brand-slate flex items-center justify-center p-6 fade-in relative">
                            {/* ヘッダーツールバー */}
                            <div className="absolute top-4 right-4 flex items-center gap-4">
                                {/* 管理者モード切替スイッチ */}
                                <div className="flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow-sm border border-gray-100">
                                    <Shield className={`w-4 h-4 ${isAdmin ? 'text-brand-blue' : 'text-gray-300'}`} />
                                    <span className={`text-xs font-bold ${isAdmin ? 'text-brand-blue' : 'text-gray-400'}`}>管理者モード</span>
                                    <button 
                                        onClick={handleAdminToggle}
                                        className={`w-10 h-5 rounded-full flex items-center p-1 transition-colors ${isAdmin ? 'bg-brand-blue' : 'bg-gray-200'}`}
                                    >
                                        <div className={`w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform ${isAdmin ? 'translate-x-5' : 'translate-x-0'}`} />
                                    </button>
                                </div>
                                {/* マイページボタン */}
                                <button onClick={handleMyPage} className="bg-white p-2 rounded-full shadow-sm border border-gray-100 text-gray-500 hover:text-brand-blue transition-colors" title="マイページ">
                                    <User className="w-5 h-5" />
                                </button>
                                {/* ログアウトボタン */}
                                <button onClick={handleLogout} className="bg-white p-2 rounded-full shadow-sm border border-gray-100 text-gray-500 hover:text-red-500 transition-colors" title="ログアウト">
                                    <LogOut className="w-5 h-5" />
                                </button>
                            </div>

                            <div className="max-w-4xl w-full">
                                <div className="text-center mb-12">
                                    <h1 className="text-4xl font-bold text-brand-blue mb-4 tracking-tight">ロボ団営業部ダッシュボード</h1>
                                    <p className="text-gray-500">管理コンソールを選択してください</p>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div onClick={handleEnterHQ} className="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-xl hover:border-brand-blue/30 transition-all group relative overflow-hidden">
                                        <div className="absolute top-0 right-0 w-32 h-32 bg-brand-blue/5 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                                        <div className="relative z-10">
                                            <div className="w-16 h-16 bg-brand-blue rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-brand-blue/20">
                                                <LayoutDashboard className="w-8 h-8 text-white" />
                                            </div>
                                            <h2 className="text-2xl font-bold text-gray-800 mb-2">本部</h2>
                                            <p className="text-sm text-gray-500 mb-6">全校データの閲覧・管理</p>
                                            <span className="inline-flex items-center text-brand-blue font-bold text-sm group-hover:translate-x-1 transition-transform">ログイン <ArrowRight className="ml-2 w-4 h-4" /></span>
                                        </div>
                                    </div>
                                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                                        <div className="absolute top-0 right-0 w-32 h-32 bg-brand-orange/5 rounded-bl-full -mr-8 -mt-8"></div>
                                        <div className="relative z-10">
                                            <div className="w-16 h-16 bg-brand-orange rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-brand-orange/20">
                                                <School className="w-8 h-8 text-white" />
                                            </div>
                                            <h2 className="text-2xl font-bold text-gray-800 mb-2">校舎</h2>
                                            <p className="text-sm text-gray-500 mb-6">日報・計画・収支入力</p>
                                            <div className="mt-4 space-y-2 max-h-48 overflow-y-auto pr-2">
                                                {campusList.map(c => (
                                                    <button key={c.id} onClick={() => handleEnterSchool(c.id)} className="w-full text-left px-4 py-3 rounded-lg border border-gray-100 hover:border-brand-orange hover:bg-orange-50 transition-colors flex items-center justify-between group">
                                                        <span className="font-bold text-gray-700 group-hover:text-brand-orange">{c.name}</span>
                                                        <ChevronRight className="w-4 h-4 text-gray-300 group-hover:text-brand-orange" />
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-8 text-center text-xs text-gray-400 flex items-center justify-center gap-4">
                                    <span className="flex items-center gap-1"><Database className={`w-3 h-3 ${isFirebaseInitialized ? 'text-emerald-500' : 'text-gray-400'}`} /> {isUsingCache ? 'Cache Mode' : 'Online Mode'}</span>
                                    <span>更新: {lastUpdated ? lastUpdated.toLocaleTimeString() : '-'}</span>
                                </div>
                            </div>
                        </div>
                    )}
                    {consoleMode === 'mypage' && <MyPage user={user} onBack={handleBack} showNotify={showNotify} />}
                    {consoleMode === 'hq' && <HQConsole onBack={handleBack} campusList={campusList} allData={allData} selectedYear={selectedYear} setSelectedYear={setSelectedYear} refreshData={handleRefresh} showNotify={showNotify} isSyncing={isSyncing} lastUpdated={lastUpdated} isUsingCache={isUsingCache} isAdmin={isAdmin} />}
                    {consoleMode === 'school' && <SchoolConsole onBack={handleBack} campus={campusList.find(c=>c.id===selectedCampusId)} allData={allData} selectedYear={selectedYear} setSelectedYear={setSelectedYear} refreshData={handleRefresh} showNotify={showNotify} isSyncing={isSyncing} lastUpdated={lastUpdated} isUsingCache={isUsingCache} isAdmin={isAdmin} />}
                </>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
